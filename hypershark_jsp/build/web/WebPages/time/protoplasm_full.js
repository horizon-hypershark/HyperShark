// All Protoplasm source code (no on-demand loading)
if(typeof Protoplasm=="undefined"){var Protoplasm=function(){var b="1.7.0.0";var g="1.8.3";var h="https://ajax.googleapis.com/ajax/libs/prototype/"+b+"/prototype.js";var d="https://ajax.googleapis.com/ajax/libs/scriptaculous/"+g+"/";var e=source=loaded=failed=used=false;var i;var c=[];var a=[];var f={};return{Version:"0.1",base:function(j){return i+j+"/"},load:function(){function j(l){var m=l.replace(/_.*|\./g,"");m=parseInt(m+"0".times(4-m.length));return l.indexOf("_")>-1?m-1:m}failed=false;if(typeof Prototype=="undefined"){Protoplasm.require(h,Protoplasm.load);return}else{if(j(Prototype.Version)<j(b)){failed=true;throw ("Protoplasm requires the Prototype JavaScript framework >= "+b)}}var k=/protoplasm(_[a-z]*)?\.js(\?.*)?$/;$$("head script[src]").findAll(function(l){return l.src.match(k)}).each(function(m){var n=m.src.match(k),l=m.src.match(/\?.*load=([a-z,]*)/);i=m.src.replace(k,"");loaded=true;if(n[1]=="_full"){e=true;Protoplasm.loadStylesheet(i+"protoplasm_full.css");return}if(n[1]=="_src"){source=true}var o=(l?l[1].split(","):a);if(o){o.each(Protoplasm.use)}})},loadStylesheet:function(k,l){if(l){k=e?i+"/protoplasm_full.css":i+l+"/"+k}if(!$$("head link[rel=stylesheet]").find(function(m){return m.href==k})){var j=new Element("link",{rel:"stylesheet",type:"text/css",href:k});$$("head")[0].appendChild(j)}},register:function(k,j){f[k]=j},require:function(m,o){if(c.indexOf(m)>-1){if(o){o()}return}c.push(m);try{if(document.loaded){throw ("Already loaded")}document.write('<script type="text/javascript" src="'+m+'"><\/script>');if(o){var j="_script_onload_"+c.length;window[j]=o;document.write('<script type="text/javascript">');document.write("window."+j+"(); delete window."+j+";");document.write("<\/script>")}}catch(n){var k=false;var l=new Element("script",{type:"text/javascript",src:m});if(o){l.onload=l.onreadystatechange=function(){var p=this.readyState;if(k||(p&&p!="complete"&&p!="loaded")){return}k=true;o()}}$$("head")[0].appendChild(l)}},transform:function(l,k){var m=Array.prototype.slice.call(arguments,2);function j(n){if(l in f){$$(k).each(function(o){var p=new f[l](o,m[0],m[1],m[2],m[3])})}}if(document.loaded){j()}else{document.on("dom:loaded",j)}return new Protoplasm.Transformer(l)},use:function(j,k){if(Object.isArray(j)){j.each(Protoplasm.use);return}if(failed){throw ("Protoplasm loading failed, cannot include controls")}else{if(!loaded){a.push(j)}else{if(!e&&!(j in f)){used||Protoplasm.loadStylesheet(i+"protoplasm.css");used=true;Protoplasm.require(i+j+"/"+j+(source?"_src":"")+".js",k)}}}return new Protoplasm.Transformer(j)},useScriptaculous:function(j,k){Protoplasm.require(d+j+".js",k)},Transformer:function(j){return{use:Protoplasm.use,transform:function(){var k=Array.prototype.slice.call(arguments,0);k.unshift(j);return Protoplasm.transform.apply(Protoplasm,k)}}},extend:function(k,j){k=$(k);j=$H(j);j.each(function(l){if(l.key in k){k["_"+l.key]=k[l.key]}k[l.key]=l.value});k.store("_extensions",j);return k},revert:function(k){k=$(k);var j=k.retrieve("_extensions");if(j){j.each(function(l){if("_"+l.key in k){k[l.key]=k["_"+l.key];k["_"+l.key]=null}else{k[l.key]=null}})}return k}}}()}Protoplasm.load();if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize accordion")}if(window.Control==undefined){Control={}}Control.Accordion=Class.create({initialize:function(a,b){this.container=$(a);this.lastExpandedTab=null;this.accordionTabs=new Array();this.setOptions(b);this._attachBehaviors();for(var c=1;c<this.accordionTabs.length;c++){this.accordionTabs[c].collapse();this.accordionTabs[c].content.style.display="none"}this.lastExpandedTab=this.accordionTabs[0];this.lastExpandedTab.content.style.height=this.options.panelHeight+"px";this.lastExpandedTab.showExpanded()},setOptions:function(a){this.options=Object.extend({panelHeight:200,onHideTab:null,onShowTab:null},a||{})},showTabByIndex:function(c,b){var a=arguments.length==1?true:b;this.showTab(this.accordionTabs[c],a)},showTab:function(f,d,e){var c=arguments.length==1?true:d;if(this.options.onHideTab){this.options.onHideTab(this.lastExpandedTab)}this.lastExpandedTab.showCollapsed();this.lastExpandedTab.content.style.height=(this.options.panelHeight-1)+"px";f.content.style.display="";var b=this;var a=this.lastExpandedTab;if(c){new Control.Accordion.Animation(this.lastExpandedTab.content,f.content,1,this.options.panelHeight,100,10,{complete:function(){b.showTabDone(a,e)}});this.lastExpandedTab=f}else{this.lastExpandedTab.content.style.height="1px";f.content.style.height=this.options.panelHeight+"px";this.lastExpandedTab=f;this.showTabDone(a)}},showTabDone:function(a,b){a.content.style.display="none";this.lastExpandedTab.showExpanded();if(!b&&this.options.onShowTab){this.options.onShowTab(this.lastExpandedTab)}},_attachBehaviors:function(){var a=this._getDirectChildrenByTag(this.container,"DIV");for(var b=0;b<a.length;b++){var e=this._getDirectChildrenByTag(a[b],"DIV");if(e.length!=2){continue}var c=e[0];var d=e[1];this.accordionTabs.push(new Control.Accordion.Tab(this,c,d))}},_getDirectChildrenByTag:function(f,d){var b=new Array();var a=f.childNodes;for(var c=0;c<a.length;c++){if(a[c]&&a[c].tagName&&a[c].tagName==d){b.push(a[c])}}return b}});Control.Accordion.Tab=Class.create({initialize:function(a,b,c){this.accordion=a;this.titleBar=b;this.content=c;this._attachBehaviors()},collapse:function(){this.showCollapsed();this.content.style.height="1px"},showCollapsed:function(){this.expanded=false;if(this.accordion.options.collapsedClass){this.titleBar.className=this.accordion.options.collapsedClass}this.content.style.overflow="hidden"},showExpanded:function(){this.expanded=true;if(this.accordion.options.expandedClass){this.titleBar.className=this.accordion.options.expandedClass}this.content.style.overflow="visible"},titleBarClicked:function(a){if(this.accordion.lastExpandedTab!=this){this.accordion.showTab(this)}},hover:function(a){if(!this.expanded&&this.accordion.options.hoverClass){this.titleBar.className=this.accordion.options.hoverClass}},unhover:function(a){if(this.expanded){if(this.accordion.options.expandedClass){this.titleBar.className=this.accordion.options.expandedClass}}else{if(this.accordion.options.collapsedClass){this.titleBar.className=this.accordion.options.collapsedClass}}},_attachBehaviors:function(){this.titleBar.onclick=this.titleBarClicked.bindAsEventListener(this);this.titleBar.onmouseover=this.hover.bindAsEventListener(this);this.titleBar.onmouseout=this.unhover.bindAsEventListener(this)}});Control.Accordion.Animation=Class.create({initialize:function(f,e,g,a,d,b,c){this.e1=$(f);this.e2=$(e);this.start=g;this.end=a;this.duration=d;this.steps=b;this.options=arguments[6]||{};this.accordionSize()},accordionSize:function(){if(this.isFinished()){this.e1.style.height=this.start+"px";this.e2.style.height=this.end+"px";if(this.options.complete){this.options.complete(this)}return}if(this.timer){clearTimeout(this.timer)}var a=Math.round(this.duration/this.steps);var b=this.steps>0?(parseInt(this.e1.offsetHeight)-this.start)/this.steps:0;this.resizeBy(b);this.duration-=a;this.steps--;this.timer=setTimeout(this.accordionSize.bind(this),a)},isFinished:function(){return this.steps<=0},resizeBy:function(b){var d=this.e1.offsetHeight;var a=this.e2.offsetHeight;var c=parseInt(b);if(b!=0){this.e1.style.height=(d-c)+"px";this.e2.style.height=(a+c)+"px"}}});Protoplasm.register("accordion",Control.Accordion);if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize colorpicker")}if(typeof Control=="undefined"){Control={}}Control.ColorPicker=Class.create({initialize:function(f,c){f=$(f);if(cp=f.retrieve("colorpicker")){cp.destroy()}this.options=Object.extend({},c||{});this.panel=new Control.ColorPicker.Panel({onSelect:this.colorSelected.bind(this)});this.opened=false;this.dialog=new Element("div",{style:"position:absolute;"});var b=new Element("div",{"class":"_pp_frame_small "+this.options.className});b.appendChild(this.panel.element);this.dialog.appendChild(b);wrapper=f.wrap(new Element("div",{"class":"inline-block"}));wrapper.style.position="relative";wrapper.style.zIndex="99";var g=f.getLayout();var e=g.get("height")-2;var a=g.get("padding-top");if(a<1){a=1;e-=(a-g.get("padding-top"))*2}var d=g.get("padding-right");if(d<1){d=1}this.swatch=new Element("div",{"class":"inputExtension",title:"Open color palette",style:"border:1px solid gray;position:absolute;fontSize:1px;display:inline-block;width:"+e+"px;height:"+e+"px;background-color:"+f.value});f.insert({after:this.swatch});console.log(g.get("right"));this.swatch.style.top=(g.get("top")+a+g.get("border-top"))+"px";this.swatch.style.right=(g.get("right")-e-3+g.get("border-right"))+"px";this.oldPadding=f.style.paddingRight;f.style.paddingRight=(e+3+g.get("padding-left")+d)+"px";f.maxLength=7;this.listeners=[f.on("change",this.textChanged.bindAsEventListener(this)),f.on("blur",this.close.bindAsEventListener(this)),this.swatch.on("click",this.toggle.bindAsEventListener(this)),this.swatch.on("selectstart",Event.stop),Event.on(window,"unload",this.destroy.bind(this))];this.clickListener=null;f.store("colorpicker",this);f._show=f.show;f._hide=f.hide;this.element=Protoplasm.extend(f,{show:wrapper.show.bind(wrapper),hide:wrapper.hide.bind(wrapper),open:this.open.bind(this),toggle:this.toggle.bind(this),close:this.close.bind(this),destroy:this.destroy.bind(this)});this.wrapper=wrapper},destroy:function(){Protoplasm.revert(this.element);this.listeners.invoke("stop");if(this.clickListener){this.clickListener.stop()}var a=this.element;this.wrapper.parentNode.replaceChild(a,this.wrapper);a.style.paddingRight=this.oldPadding;a.store("colorpicker",null)},colorSelected:function(a){this.element.value=a;this.swatch.style.backgroundColor=a;this.close()},textChanged:function(a){this.swatch.style.backgroundColor=this.element.value},toggle:function(a){if(this.opened){this.close()}else{this.open()}},open:function(c){if(!this.opened){var b=this.element.getLayout();document.body.appendChild(this.dialog);var a=b.get("border-box-height")-b.get("border-bottom");this.dialog.clonePosition(this.element,{setWidth:false,setHeight:false,offsetTop:a,offsetLeft:-3});this.clickListener=document.on("click",this.clickHandler.bindAsEventListener(this));this.opened=true}},close:function(a){if(this.opened){if(this.clickListener){this.clickListener.stop()}this.dialog.remove();this.opened=false}},clickHandler:function(b){var a=Event.element(b);do{if(a==this.swatch||a==this.dialog){return}}while(a=a.parentNode);this.close()}});Control.ColorPicker.Panel=Class.create({initialize:function(a){this.options=Object.extend({addLabel:"Add",colors:Array("#000000","#993300","#333300","#003300","#003366","#000080","#333399","#333333","#800000","#FF6600","#808000","#008000","#008080","#0000FF","#666699","#808080","#FF0000","#FF9900","#99CC00","#339966","#33CCCC","#3366FF","#800080","#969696","#FF00FF","#FFCC00","#FFFF00","#00FF00","#00FFFF","#00CCFF","#993366","#C0C0C0","#FF99CC","#FFCC99","#FFFF99","#CCFFCC","#CCFFFF","#99CCFF","#CC99FF","#FFFFFF"),onSelect:Prototype.emptyFunction},a||{});this.customSwatches=[];this.activeCustom=null,this.element=this.create()},create:function(){var q=document.createElement("div");var a=this.options.colors;var p,n;var o=new Element("table",{cellPadding:0,cellSpacing:0,border:0});for(var f=0;f<5;++f){p=o.insertRow(f);for(var e=0;e<8;++e){n=p.insertCell(e);Element.setStyle(n,{border:"0px",padding:"0px"});var d=a[(8*f)+e];var m=new Element("div",{style:"width:15px;height:15px;font-size:1px;border:1px solid #EEEEEE;background-color:"+d+";padding:0"});m.on("click",this.clickListener(d));m.on("mouseover",this.hoverListener(d));n.appendChild(m)}}this.addSpacerRow(o,5);p=o.insertRow(6);var k=this.loadSetting("customColors")?this.loadSetting("customColors").split(","):new Array();this.customSwatches=[];for(var f=0;f<8;++f){n=p.insertCell(f);Element.setStyle(n,{border:"0",padding:"0"});var d=k[f]?k[f]:"#000000";var m=new Element("div",{style:"width:15px;height:15px;fontSize:15px;border:1px solid #EEEEEE;background-color:"+d+";padding:0"});n.appendChild(m);m.on("click",this.customClickListener(d,m));m.on("mouseover",this.hoverListener(d));this.customSwatches.push(m)}this.addSpacerRow(o,7);p=o.insertRow(8);n=p.insertCell(0);Element.setStyle(n,{border:"0",padding:"0"});n.colSpan=8;var b=new Element("table",{cellspacing:0,cellpadding:0,border:0,style:"width:136px;"});n.appendChild(b);p=b.insertRow(0);n=p.insertCell(0);Element.setStyle(n,{border:"0",padding:"0","vertical-align":"middle"});var g=new Element("div",{style:"width:15px;height:15px;fontSize:15px;border:1px solid #EEEEEE;background-color:#000000"});n.appendChild(g);this.previewSwatch=g;n=p.insertCell(1);Element.setStyle(n,{border:"0",padding:"0","vertical-align":"middle","text-align":"center"});var l=new Element("input",{type:"text",value:"#000000",style:"width:70px;border:1px solid gray"});l.on("keyup",function(i){this.previewSwatch.style.backgroundColor=l.value}.bindAsEventListener(this));n.appendChild(l);this.customInput=l;n=p.insertCell(2);Element.setStyle(n,{border:"0",padding:"0","vertical-align":"middle","text-align":"right"});var h=new Element("input",{type:"button",value:this.options.addLabel,style:"width:40px;border:1px solid gray"});h.on("click",function(s){var j=0;if(this.activeCustom){for(var r=0;r<this.customSwatches.length;++r){if(this.customSwatches[r]==this.activeCustom){j=r;break}}this.activeCustom.style.border="1px solid #EEEEEE";this.activeCustom=null}else{var t=this.loadSetting("customColorIndex");if(t){j=(parseInt(t)+1)%8}}this.saveSetting("customColorIndex",j);k[j]=this.customSwatches[j].style.backgroundColor=this.customInput.value;this.customSwatches[j].onclick=this.customClickListener(k[j],this.customSwatches[j]);this.customSwatches[j].onmouseover=this.hoverListener(k[j]);this.saveSetting("customColors",k.join(","))}.bindAsEventListener(this));n.appendChild(h);var c=new Element("form",{style:"margin:0;padding:0"});c.onsubmit=function(){if(this.activeCustom){this.activeCustom.style.border="1px solid #EEEEEE"}this.activeCustom=null;this.editor.setDialogColor(this.customInput.value);return false}.bindAsEventListener(this);c.appendChild(o);q.appendChild(c);return q},addSpacerRow:function(b,a){var c=b.insertRow(a);cell=c.insertCell(0);cell.colSpan=8;Element.setStyle(cell,{border:"0",padding:"0"});cell.appendChild(new Element("hr",{style:"color:gray;background-color:gray;height:1px;border:0;margin-top:3px;margin-bottom:3px;padding:0"}));return c},clickListener:function(a){return function(b){if(this.activeCustom){this.activeCustom.style.border="1px solid #EEEEEE"}this.activeCustom=null;this.options.onSelect(a)}.bindAsEventListener(this)},customClickListener:function(a,b){return function(c){if(c.ctrlKey){if(this.activeCustom){this.activeCustom.style.border="1px solid #EEEEEE"}this.activeCustom=b;this.activeCustom.style.border="1px solid #FF0000"}else{this.activeCustom=null;this.options.onSelect(a)}}.bindAsEventListener(this)},hoverListener:function(a){return function(b){this.previewSwatch.style.backgroundColor=a;this.customInput.value=a}.bindAsEventListener(this)},loadSetting:function(b){b="colorpicker_"+b;var e=b+"=";var a=document.cookie.split(";");for(var d=0;d<a.length;d++){var f=a[d];while(f.charAt(0)==" "){f=f.substring(1,f.length)}if(f.indexOf(e)==0){return f.substring(e.length,f.length)}}return null},saveSetting:function(c,d,e){c="colorpicker_"+c;if(!e){e=180}var b=new Date();b.setTime(b.getTime()+(e*24*60*60*1000));var a="; expires="+b.toGMTString();document.cookie=c+"="+d+a+"; path=/"},clearSetting:function(a){this.saveSetting(a,"",-1)}});Protoplasm.register("colorpicker",Control.ColorPicker);if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize datepicker")}if(typeof Control=="undefined"){Control={}}Protoplasm.use("timepicker");Protoplasm.loadStylesheet("datepicker.css","datepicker");Control.DatePicker=Class.create({initialize:function(element,options){element=$(element);if(dp=element.retrieve("datepicker")){dp.destroy()}var wrapper=element.wrap(new Element("span"));wrapper.style.position="relative";options=Object.extend({timePicker:false,manual:true},options||{});if(!options.icon){options.icon=Protoplasm.base("datepicker")+"calendar.png"}this.element=element;this.anchor=element;this.wrapper=wrapper;this.panel=null;this.dialog=null;this.handlers={onClick:options.onClick,onHover:options.onHover,onSelect:options.onSelect};this.options=Object.extend(options||{},{onClick:this.pickerClicked.bind(this),onHover:this.dateHover.bind(this),onSelect:this.datePicked.bind(this)});var locale=options&&options.locale?options.locale:"en_US";try{this.setLocale(new Control.DatePicker.i18n(locale))}catch(e){new Ajax.Request(Protoplasm.base("datepicker")+"locales/"+locale+".js",{onSuccess:function(transport){eval(transport.responseText);this.setLocale(new Control.DatePicker.i18n(locale),true)}.bind(this),onFailure:function(transport){this.setLocale(new Control.DatePicker.i18n("en_US"),true)}.bind(this)})}this.listeners=[document.on("keydown",this.docKeyHandler.bindAsEventListener(this)),Event.on(window,"unload",this.destroy.bind(this))];this.originalRange={start:null,end:null};if(options.range){this.rangeEnd=options.rangeEnd?$(options.rangeEnd):wrapper.next("input[type=text]")}if(options.icon){element.style.background="url("+options.icon+") right center no-repeat #FFF";this.oldPadding=element.style.paddingRight;element.style.paddingRight="20px";if(this.rangeEnd){this.rangeEnd.style.background="url("+options.icon+") right center no-repeat #FFF";this.rangeEnd.style.paddingRight="20px"}}if(options.epoch){this.startLabel=this.makeEpochLabel(element);this.addListener(this.startLabel);this.anchor=this.startLabel;if(this.rangeEnd){this.endLabel=this.makeEpochLabel(this.rangeEnd);this.addListener(this.endLabel)}}else{this.addListener(element);if(this.rangeEnd){this.addListener(this.rangeEnd)}element.readOnly=!this.options.manual}this.hidePickerListener=null;this.pickerActive=false;this.element.store("datepicker",this);this.element=Protoplasm.extend(element,{show:wrapper.show.bind(wrapper),hide:wrapper.hide.bind(wrapper),open:this.open.bind(this),toggle:this.toggle.bind(this),close:this.close.bind(this),destroy:this.destroy.bind(this)})},makeEpochLabel:function(b){var a=b.clone();a.name=null;a.on("change",function(){var c=Control.DatePicker.DateFormat.parseFormat(a.value,this.options.currentFormat);if(c){b.value=c.getTime()}});a.id=null;a.readOnly=!this.options.manual;b.type="hidden";if(b.value){a.value=this.options.currentFormat?Control.DatePicker.DateFormat.format(new Date(parseInt(b.value)),this.options.currentFormat):""}b.insert({after:a});return a},addListener:function(a){this.listeners.push(a.on("click",this.toggle.bindAsEventListener(this)));this.listeners.push(a.on("keydown",this.keyHandler.bindAsEventListener(this)))},setLocale:function(a,c){this.i18n=a;this.options=this.i18n.inheritOptions(this.options);if(!this.options.range&&this.options.timePicker){this.options.currentFormat=this.options.dateTimeFormat}else{this.options.currentFormat=this.options.dateFormat}this.options.date=Control.DatePicker.DateFormat.parseFormat(this.element.value,this.options.currentFormat);if(this.options.range&&this.rangeEnd){this.options.endDate=Control.DatePicker.DateFormat.parseFormat(this.rangeEnd.value,this.options.currentFormat)}if(c){var b=this.getValue();this.setValue(b.start,b.end)}},destroy:function(){Protoplasm.revert(this.element);this.listeners.invoke("stop");if(this.hidePickerListener){this.hidePickerListener.stop()}this.wrapper.parentNode.replaceChild(this.element,this.wrapper);this.element.style.paddingRight=this.oldPadding;this.element.store("datepicker",null)},tr:function(a){return this.i18n.tr(a)},clickHandler:function(b){var a=Event.element(b);do{if(a==document){break}if(a==this.element||a==this.startValue||a==this.endValue||a==this.dialog){return}}while(a=a.parentNode);if(!a){return}this.close()},pickerClicked:function(){if(this.handlers.onClick){this.handlers.onClick()}},datePicked:function(b,a){this.setValue(b,a);this.element.focus();this.close();if(this.handlers.onSelect){this.handlers.onSelect(b,a)}if(this.element.onchange){this.element.onchange()}},dateHover:function(b,a){if(this.pickerActive){this.setValue(b,a);if(this.handlers.onHover){this.handlers.onHover(b,a)}}},toggle:function(a){if(this.pickerActive){this.setValue(this.originalRange.start,this.originalRange.end);this.close()}else{setTimeout(this.open.bind(this))}return false},setValue:function(b,a){startLabel=b?Control.DatePicker.DateFormat.format(b,this.options.currentFormat):null;startValue=b&&this.options.epoch?b.getTime():startLabel;endLabel=a?Control.DatePicker.DateFormat.format(a,this.options.currentFormat):null;endValue=a&&this.options.epoch?a.getTime():endLabel;this.element.value=startValue?startValue:"";if(this.options.epoch){this.startLabel.value=startLabel?startLabel:""}if(this.rangeEnd){this.rangeEnd.value=endValue?endValue:"";if(this.options.epoch){this.endLabel.value=endLabel?endLabel:""}}},getValue:function(){var a={start:null,end:null};if(this.element.value){a.start=this.options.epoch?new Date(parseInt(this.element.value)):Control.DatePicker.DateFormat.parseFormat(this.element.value,this.options.currentFormat)}if(this.rangeEnd&&this.rangeEnd.value){a.end=this.options.epoch?new Date(parseInt(this.rangeEnd.value)):Control.DatePicker.DateFormat.parseFormat(this.rangeEnd.value,this.options.currentFormat)}return a},docKeyHandler:function(a){if(a.keyCode==Event.KEY_ESC){if(this.pickerActive){this.setValue(this.originalRange.start,this.originalRange.end);this.close()}}},keyHandler:function(a){switch(a.keyCode){case Event.KEY_ESC:if(this.pickerActive){this.setValue(this.originalRange.start,this.originalRange.end)}case Event.KEY_TAB:this.close();return;case Event.KEY_DOWN:if(!this.pickerActive){this.open();Event.stop(a)}}if(this.pickerActive){return false}},close:function(){if(this.pickerActive&&!this.element.disabled){this.panel.releaseKeys();this.dialog.remove();if(this.hidePickerListener){this.hidePickerListener.stop();this.hidePickerListener=null}this.pickerActive=false;Control.DatePicker.activePicker=null}},open:function(){if(!this.pickerActive){if(Control.DatePicker.activePicker){Control.DatePicker.activePicker.close()}this.anchor.focus();if(!this.dialog){this.panel=new Control.DatePicker.Panel(this.options);this.dialog=new Element("div",{"class":"_pp_frame_small _pp_datepicker "+this.options.className,style:"position:absolute;"});this.dialog.appendChild(this.panel.element)}this.originalRange=this.getValue();var b=this.anchor.getLayout();var a=b.get("border-box-height")-b.get("border-bottom");document.body.appendChild(this.dialog);this.anchor.style.position="relative";this.dialog.clonePosition(this.anchor,{setWidth:false,setHeight:false,offsetTop:a,offsetLeft:-3});this.dialog.style.zIndex="99";this.panel.selectRange(this.originalRange.start,this.originalRange.end);this.panel.captureKeys();this.hidePickerListener=document.on("click",this.clickHandler.bindAsEventListener(this));this.pickerActive=true;Control.DatePicker.activePicker=this;this.pickerClicked()}}});Control.DatePicker.activePicker=null;Control.DatePicker.create=function(b){b=Object.extend({className:"datepicker",name:"date"},b||{});var a=new Element("input",{"class":b.className,name:name});var c=new Control.DatePicker(a);c.wrapper.store("datepicker",c);return c.wrapper};Control.DatePicker.i18n=Class.create();Object.extend(Control.DatePicker.i18n,{available:["cs_CZ","el_GR","fr_FR","it_IT","lt_LT","nl_NL","pl_PL","pt_BR","ru_RU"],baseLocales:{us:{dateTimeFormat:"MM-dd-yyyy HH:mm:ss",dateFormat:"MM-dd-yyyy",firstWeekDay:0,weekend:[0,6],timeFormat:"HH:mm:ss"},eu:{dateTimeFormat:"dd-MM-yyyy HH:mm:ss",dateFormat:"dd-MM-yyyy",firstWeekDay:1,weekend:[0,6],timeFormat:"HH:mm:ss"},iso8601:{dateTimeFormat:"yyyy-MM-dd HH:mm:ss",dateFormat:"yyyy-MM-dd",firstWeekDay:1,weekend:[0,6],timeFormat:"HH:mm:ss"}},createLocale:function(a,b){return Object.extend(Object.clone(Control.DatePicker.i18n.baseLocales[a]),{language:b})}});Control.DatePicker.i18n.prototype={initialize:function(a){if(a){this.setLocale(a)}},setLocale:function(b){if(!(b in Control.DatePicker.Locale)&&Control.DatePicker.i18n.available.indexOf(b)>-1){throw ("Locale available but not loaded")}var c=b.charAt(2)=="_"?b.substring(0,2):b;var a=(Control.DatePicker.Locale[b]||Control.DatePicker.Locale[c]);this.opts=Object.clone(a||{});var d=a?Control.DatePicker.Language[a.language]:null;if(d){Object.extend(this.opts,d)}},opts:null,inheritOptions:function(a){if(!this.opts){this.setLocale("en_US")}return Object.extend(this.opts,a||{})},tr:function(a){return this.opts&&this.opts.strings?this.opts.strings[a]||a:a}};Control.DatePicker.Locale={};with(Control.DatePicker){Locale.es=i18n.createLocale("eu","es");Locale.en=i18n.createLocale("us","en");Locale.en_GB=i18n.createLocale("eu","en");Locale.en_AU=Locale.en_GB;Locale.de=i18n.createLocale("eu","de");Locale.es_iso8601=i18n.createLocale("iso8601","es");Locale.en_iso8601=i18n.createLocale("iso8601","en");Locale.de_iso8601=i18n.createLocale("iso8601","de")}Control.DatePicker.Language={es:{months:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Augosto","Septiembre","Octubre","Novimbre","Diciembre"],days:["Do","Lu","Ma","Mi","Ju","Vi","Sa"],strings:{Now:"Ahora",Today:"Hoy",Time:"Hora","Exact minutes":"Minuto exacto","Select Date and Time":"Selecciona Dia y Hora","Select Time":"Selecciona Hora","Open calendar":"Abre calendario"}},de:{months:["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"],days:["So","Mo","Di","Mi","Do","Fr","Sa"],strings:{Now:"Jetzt",Today:"Heute",Time:"Zeit","Exact minutes":"Exakte minuten","Select Date and Time":"Zeit und Datum Auswählen","Select Time":"Zeit Auswählen","Open calendar":"Kalender öffnen"}}};Control.DatePicker.Panel=Class.create(function(){function pad(x){if(x<10){return"0"+x}return new String(x)}return{initialize:function(options){try{this.i18n=new Control.DatePicker.i18n(options&&options.locale?options.locale:"en_US");options=this.i18n.inheritOptions(options)}catch(e){this.i18n=new Control.DatePicker.i18n()}this.options=Object.extend({className:"",closeOnToday:true,selectToday:true,timePicker:false,use24hrs:false,firstWeekDay:0,weekend:[0,6],months:["January","February","March","April","May","June","July","August","September","October","November","December"],days:["Su","Mo","Tu","We","Th","Fr","Sa"]},options||{});with(this.options){if(isNaN(firstWeekDay*1)){firstWeekDay=0}else{firstWeekDay=firstWeekDay%7}}this.calendarCont=null;this.currentDate=this.options.date?this.options.date:new Date();this.dayOfWeek=0;this.minInterval=5;this.rangeStart=this.currentDate;this.rangeEnd=this.options.dateEnd;this.inRange=false;this.position=this.options.position;this.selectedDays=[];this.currentDays={};this.visibleDays={};this.invisibleDays={};this.element=this.createPicker();this.selectDate(this.currentDate);this.element.on("selectstart",function(e){Event.stop(e)}.bindAsEventListener(this))},createPicker:function(){var elt=new Element("div",{"class":"_pp_datepicker "+this.options.className});this.calendarCont=this.drawCalendar(elt,this.currentDate);Event.observe(elt,"click",this.clickHandler.bindAsEventListener(this));this.keyListener=document.on("keydown",this.keyHandler.bindAsEventListener(this));document.on("click",function(e){if(!e.findElement("._pp_datepicker")){this.keyListener.stop()}}.bindAsEventListener(this));if(!this.options.captureKeys){this.keyListener.stop()}return elt},tr:function(str){return this.i18n.tr(str)},captureKeys:function(){this.keyListener.start()},releaseKeys:function(){this.keyListener.stop()},setDate:function(date,recenter){if(date){this.element.update();var dateKey=this.dateKey(date);if(!(dateKey in this.visibleDays)){if(recenter){this.position=this.options.position}else{if(date<this.currentDate){this.position="left"}else{if(date>this.currentDate){this.position="right"}else{this.position=this.options.position}}}}this.calendarCont=this.drawCalendar(this.element,date)}},drawCalendar:function(container,date){var calendar=this.createCalendar(date);container.appendChild(calendar);container.style.width=calendar.style.width;if(!this.options.range&&this.options.timePicker){var selectListener=function(e){if(this.options.onSelect){this.options.onSelect(this.currentDate)}}.bindAsEventListener(this);var tp=new Control.TimePicker.Panel({onChange:this.selectTime.bind(this),onSelect:selectListener,use24hrs:this.options.use24hrs});var timewrap=new Element("table",{style:"margin: 3px auto;"});var row=timewrap.insertRow(0);var cell=$(row.insertCell(0));cell.appendChild(tp.element);container.appendChild(timewrap);tp.setTime(this.currentDate);this.timePicker=tp;var select=new Element("button").update(this.tr("Select Date and Time"));select.on("click",selectListener);container.appendChild(select)}return container},createCalendar:function(date){this.currentDays={};this.visibleDays={};this.invisibleDays={};var wrapper=new Element("div");var header=this.createHeader(date);wrapper.appendChild(header);if((months=this.options.monthCount)&&months>1){if(months>3){months=3}wrapper.style.width=(180*months+(months-1)*3)+"px";var vertical=(this.options.layout=="vertical");var row;if(!vertical){var table=new Element("table",{cellPadding:0,cellSpacing:0,border:0});row=table.insertRow(0);wrapper.appendChild(table)}var start=new Date(date.getTime());start.setDate(1);if(this.position&&this.position=="left"){}else{if(this.position&&this.position=="right"){start.setMonth(start.getMonth()-(months-1))}else{start.setMonth(start.getMonth()-Math.floor(months/2))}}for(var i=0;i<months;i++){var cal=this.createMonth(start);if(!vertical){if(i>0){cal.style.marginLeft="3px"}}else{if(i>0){cal.style.marginTop="3px"}}if(!vertical){var cell=$(row.insertCell(row.cells.length));cell.appendChild(cal)}else{wrapper.appendChild(cal)}start.setMonth(start.getMonth()+1)}}else{wrapper.style.width="180px";wrapper.appendChild(this.createMonth(date))}return wrapper},createHeader:function(date){var today=new Date();var previousYear=new Date(date.getFullYear()-1,date.getMonth(),1);var previousMonth=new Date(date.getFullYear(),date.getMonth()-1,1);var nextMonth=new Date(date.getFullYear(),date.getMonth()+1,1);var nextYear=new Date(date.getFullYear()+1,date.getMonth(),1);var nav=new Element("div",{"class":"_pp_datepicker_navigation"});var link=new Element("span",{"class":"_pp_datepicker_previous",title:this.monthName(previousYear.getMonth())+" "+previousYear.getFullYear()}).update("&lt;&lt;");link.on("click",this.movePreviousYearListener());nav.insert(link);link=new Element("span",{"class":"_pp_datepicker_previous",title:this.monthName(previousMonth.getMonth())+" "+previousMonth.getFullYear()}).update("&lt;");link.on("click",this.movePreviousMonthListener());nav.insert(link);link=new Element("span",{"class":"_pp_datepicker_next",title:this.monthName(nextYear.getMonth())+" "+nextYear.getFullYear()}).update("&gt;&gt;");link.on("click",this.moveNextYearListener());nav.insert(link);link=new Element("span",{"class":"_pp_datepicker_next",title:this.monthName(nextMonth.getMonth())+" "+nextMonth.getFullYear()}).update("&gt;");link.on("click",this.moveNextMonthListener());nav.insert(link);link=new Element("div",{"class":"_pp_datepicker_today",title:today.getDate()+" "+this.monthName(today.getMonth())+" "+today.getFullYear()}).update(this.options.timePicker?this.tr("Now"):this.tr("Today"));link.on("click",this.clickedListener(today,true));nav.insert(link);return nav},createMonth:function(date){var table=new Element("table",{cellSpacing:0,cellPadding:0,border:0,"class":"_pp_datepicker_table"});var row=$(table.insertRow(table.rows.length));if(this.options.range){row.insertCell(0)}cell=$(row.insertCell(row.cells.length));cell.className="_pp_title";cell.colSpan=7;cell.update(this.monthName(date.getMonth())+" "+date.getFullYear());row=$(table.insertRow(table.rows.length));if(this.options.range){row.insertCell(0)}for(var i=0;i<7;++i){cell=new Element("th",{width:"14%","class":"_pp_highlight"}).update(this.dayName((this.options.firstWeekDay+i)%7));row.insert(cell)}var workDate=new Date(date.getFullYear(),date.getMonth(),1);var day=workDate.getDay();if(day!=this.options.firstWeekDay){row=$(table.insertRow(table.rows.length));workDate.setDate(workDate.getDate()-((day-this.options.firstWeekDay+7)%7));if(this.options.range){cell=$(row.insertCell(row.cells.length));cell.className="_pp_datepicker_weekselect";cell.on("mousedown",this.weekClicked(workDate))}day=workDate.getDay();while(workDate.getMonth()!=date.getMonth()){cell=new Element("td").update(workDate.getDate());this.assignDayClasses(cell,"dayothermonth",workDate);cell.on("mousedown",this.rangeStartListener(workDate));cell.on("mouseover",this.hoverListener(workDate));cell.on("mouseup",this.rangeEndListener(workDate));var dateKey=this.dateKey(workDate);this.invisibleDays[dateKey]=cell;row.insert(cell);workDate.setDate(workDate.getDate()+1);day=workDate.getDay()}}while(workDate.getMonth()==date.getMonth()){if(day==this.options.firstWeekDay){row=$(table.insertRow(table.rows.length));if(this.options.range){if(this.options.range){cell=new Element("td",{"class":"_pp_datepicker_weekselect"});cell.on("mousedown",this.weekClicked(workDate));row.insert(cell)}}}cell=new Element("td").update(workDate.getDate());this.assignDayClasses(cell,"day",workDate);row.insert(cell);cell.on("mousedown",this.rangeStartListener(workDate));cell.on("mouseover",this.hoverListener(workDate));cell.on("mouseup",this.rangeEndListener(workDate));var dateKey=this.dateKey(workDate);this.visibleDays[dateKey]=cell;if(workDate.getFullYear()==this.currentDate.getFullYear()&&workDate.getMonth()==this.currentDate.getMonth()){this.currentDays[dateKey]=cell}workDate.setDate(workDate.getDate()+1);day=workDate.getDay()}if(day!=this.options.firstWeekDay){do{cell=new Element("td").update(workDate.getDate());this.assignDayClasses(cell,"dayothermonth",workDate);row.insert(cell);var thisDate=new Date(workDate.getTime());cell.on("mousedown",this.rangeStartListener(workDate));cell.on("mouseover",this.hoverListener(workDate));cell.on("mouseup",this.rangeEndListener(workDate));var dateKey=this.dateKey(workDate);this.invisibleDays[dateKey]=cell;workDate.setDate(workDate.getDate()+1);day=workDate.getDay()}while(workDate.getDay()!=this.options.firstWeekDay)}return table},movePreviousMonthListener:function(){return function(e){var d=this.currentDate;var prevMonth=new Date(d.getFullYear(),d.getMonth()-1,d.getDate(),d.getHours(),d.getMinutes());if(prevMonth.getMonth()!=(d.getMonth()+11)%12){prevMonth.setDate(0)}this.selectDate(prevMonth,false,true)}.bindAsEventListener(this)},moveNextMonthListener:function(){return function(e){var d=this.currentDate;var nextMonth=new Date(d.getFullYear(),d.getMonth()+1,d.getDate(),d.getHours(),d.getMinutes());if(nextMonth.getMonth()!=(d.getMonth()+1)%12){nextMonth.setDate(0)}this.selectDate(nextMonth,false,true)}.bindAsEventListener(this)},moveNextYearListener:function(){return function(e){var d=this.currentDate;var nextYear=new Date(d.getFullYear()+1,d.getMonth(),d.getDate(),d.getHours(),d.getMinutes());if(nextYear.getMonth()!=d.getMonth()){nextYear.setDate(0)}this.selectDate(nextYear,false,true)}.bindAsEventListener(this)},movePreviousYearListener:function(){return function(e){var d=this.currentDate;var prevYear=new Date(d.getFullYear()-1,d.getMonth(),d.getDate(),d.getHours(),d.getMinutes());if(prevYear.getMonth()!=d.getMonth()){prevYear.setDate(0)}this.selectDate(prevYear,false,true)}.bindAsEventListener(this)},copyDate:function(d,timeOverride){var d2=new Date(d.getTime());var c=this.currentDate;if(!timeOverride){d2.setHours(c.getHours());d2.setMinutes(c.getMinutes());d2.setSeconds(c.getSeconds());d2.setMilliseconds(c.getMilliseconds())}return d2},rangeStartListener:function(date){var d=this.copyDate(date);return function(e){if(this.options.range){if(this.dragging){return}this.dragging=true;this.dragged=false}this.dateClicked(d)}.bindAsEventListener(this)},rangeEndListener:function(date){var d=this.copyDate(date);return function(e){if(this.options.range){this.dragging=false;if(this.dragged){this.dateClicked(d)}}}.bindAsEventListener(this)},hoverListener:function(date){var d=this.copyDate(date);return function(e){if(this.options.range&&this.dragging){this.dragged=true;this.dateClicked(d,true)}}.bindAsEventListener(this)},moveListener:function(date,timeOverride){var d=this.copyDate(date,timeOverride);return function(e){this.selectDate(d,false,true)}.bindAsEventListener(this)},clickedListener:function(date,timeOverride){var d=this.copyDate(date,timeOverride);return function(e){this.dateClicked(d)}.bindAsEventListener(this)},assignDayClasses:function(cell,baseClass,date){cell=$(cell);var today=new Date();cell.addClassName(baseClass);if(date.getFullYear()==today.getFullYear()&&date.getMonth()==today.getMonth()&&date.getDate()==today.getDate()){cell.addClassName("today")}if(this.options.weekend.include(date.getDay())){cell.addClassName("weekend")}if((this.options.minDate&&date<this.options.minDate)||(this.options.maxDate&&date>this.options.maxDate)){cell.addClassName("disabled")}},monthName:function(month){return this.options.months[month]},dayName:function(day){return this.options.days[day]},clickHandler:function(e){this.captureKeys();if(this.options.onClick){this.options.onClick()}},keyHandler:function(e){var days=0;switch(e.keyCode){case Event.KEY_RETURN:if(this.options.onSelect){this.options.onSelect(this.currentDate)}break;case Event.KEY_LEFT:days=-1;break;case Event.KEY_UP:days=-7;break;case Event.KEY_RIGHT:days=1;break;case Event.KEY_DOWN:days=7;break;case 33:var lastMonth=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth()-1,this.currentDate.getDate());days=-this.getDaysOfMonth(lastMonth);break;case 34:days=this.getDaysOfMonth(this.currentDate);break;case 13:this.dateClicked(this.currentDate);break;default:return}if(days!=0){var moveDate=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth(),this.currentDate.getDate()+days);moveDate.setHours(this.currentDate.getHours());moveDate.setMinutes(this.currentDate.getMinutes());moveDate.setSeconds(this.currentDate.getSeconds());moveDate.setMilliseconds(this.currentDate.getMilliseconds());this.selectDate(moveDate)}Event.stop(e);return false},getDaysOfMonth:function(date){var lastDay=new Date(date.getFullYear(),date.getMonth()+1,0);return lastDay.getDate()},getNextMonth:function(month,year,increment){if(p_Month==11){return[0,year+1]}else{return[month+1,year]}},getPrevMonth:function(month,year,increment){if(p_Month==0){return[11,year-1]}else{return[month-1,year]}},dateClicked:function(date,dragging){if(date){var endRange=this.inRange&&!dragging;if(!dragging){this.inRange=false}this.selectDate(date,!endRange);if(this.options.onSelect){if(this.options.range){if(endRange&&this.rangeStart){if(this.rangeStart<this.rangeEnd){this.options.onSelect(this.rangeStart,this.rangeEnd)}else{this.options.onSelect(this.rangeEnd,this.rangeStart)}this.dragging=false}}else{if(!this.options.timePicker){this.options.onSelect(date)}}}var dateKey=this.dateKey(date);if(!(dateKey in this.currentDays)||this.position!=this.options.position){this.position=this.options.position}}},dateKey:function(date){return date.getFullYear()+pad(date.getMonth())+pad(date.getDate())},applyClass:function(date,klass){var k=this.dateKey(date);if(k in this.visibleDays){this.visibleDays[k].addClassName(klass)}if(k in this.invisibleDays){this.invisibleDays[k].addClassName(klass)}},weekClicked:function(first){var start=new Date(first.getTime());var end=new Date(first.getTime());end.setDate(end.getDate()+6);return function(e){this.selectRange(start,end)}.bindAsEventListener(this)},selectRange:function(start,end){this.inRange=false;this.dateClicked(start);if(this.options.range){this.dateClicked(end)}},selectDate:function(date,startRange,noRange){if(date){if(this.options.minDate&&date<this.options.minDate){date=this.options.minDate}else{if(this.options.maxDate&&date>this.options.maxDate){date=this.options.maxDate}}this.currentDate=date;var dateKey=this.dateKey(date);if(!(dateKey in this.visibleDays)||(noRange&&!(dateKey in this.currentDays))){this.setDate(date,noRange)}this.selectedDays.invoke("removeClassName","current");if(this.options.range){this.selectedDays.invoke("removeClassName","leftrange");this.selectedDays.invoke("removeClassName","rightrange");this.selectedDays.invoke("removeClassName","currenthint");if(!noRange){if(!this.inRange&&startRange){this.inRange=true;this.rangeStart=date}this.rangeEnd=date}this.selectedDays=[];if(this.rangeStart){var low,high;if(this.rangeEnd<this.rangeStart){low=new Date(this.rangeEnd.getFullYear(),this.rangeEnd.getMonth(),this.rangeEnd.getDate());high=new Date(this.rangeStart.getFullYear(),this.rangeStart.getMonth(),this.rangeStart.getDate())}else{low=new Date(this.rangeStart.getFullYear(),this.rangeStart.getMonth(),this.rangeStart.getDate());high=new Date(this.rangeEnd.getFullYear(),this.rangeEnd.getMonth(),this.rangeEnd.getDate())}this.applyClass(low,"leftrange");if(low.getTime()!=high.getTime()){this.applyClass(high,"rightrange")}while(low.getTime()<=high.getTime()){var k=this.dateKey(low);if(k in this.visibleDays){this.visibleDays[k].addClassName("current");this.selectedDays.push(this.visibleDays[k])}if(k in this.invisibleDays){this.invisibleDays[k].addClassName("currenthint");this.selectedDays.push(this.invisibleDays[k])}low.setDate(low.getDate()+1)}}}else{this.selectedDays.invoke("removeClassName","singlerange");this.visibleDays[dateKey].addClassName("singlerange");this.selectedDays=[this.visibleDays[dateKey]]}if(this.options.timePicker){this.timePicker.setTime(date)}if(this.options.onHover){if(this.options.range){this.options.onHover(this.rangeStart,this.rangeEnd)}else{this.options.onHover(date)}}}},selectTime:function(time){this.currentDate.setHours(time.getHours());this.currentDate.setMinutes(time.getMinutes());this.currentDate.setSeconds(time.getSeconds());this.currentDate.setMilliseconds(time.getMilliseconds());if(this.options.onHover){this.options.onHover(this.currentDate)}}}}());Control.DatePicker.DateFormat=Class.create({initialize:function(a){this.format=a},parse:function(a){return Control.DatePicker.DateFormat.parseFormat(a,this.format)},format:function(a){return Control.DatePicker.DateFormat.format(a,this.format)}});Object.extend(Control.DatePicker.DateFormat,{MONTH_NAMES:["January","February","March","April","May","June","July","August","September","October","November","December","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],DAY_NAMES:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sun","Mon","Tue","Wed","Thu","Fri","Sat"],LZ:function(a,b){b=b||2;a=""+a;while(a.length<b){a="0"+a}return a},compareDates:function(e,f,c,d){var b=Control.DatePicker.DateFormat.parseFormat(e,f);var a=Control.DatePicker.DateFormat.parseFormat(c,d);if(b==0||a==0){return -1}else{if(b>a){return 1}}return 0},format:function(N,I){var Q=Control.DatePicker.DateFormat.LZ;var n=Control.DatePicker.DateFormat.MONTH_NAMES;var z=Control.DatePicker.DateFormat.DAY_NAMES;I=I+"";var o="";var x=0;var L="";var g="";var l=N.getYear()+"";var i=N.getMonth()+1;var J=N.getDate();var q=N.getDay();var p=N.getHours();var B=N.getMinutes();var t=N.getSeconds();var f=N.getMilliseconds();var v,w,b,u,O,e,G,F,C,r,R,p,P,j,a,D;var A=new Object();if(l.length<4){l=""+(l-0+1900)}A.y=""+l;A.yyyy=l;A.yy=l.substring(2,4);A.M=i;A.MM=Q(i);A.MMM=n[i-1];A.NNN=n[i+11];A.d=J;A.dd=Q(J);A.E=z[q+7];A.EE=z[q];A.H=p;A.HH=Q(p);if(p==0){A.h=12}else{if(p>12){A.h=p-12}else{A.h=p}}A.hh=Q(A.h);if(p>11){A.K=p-12}else{A.K=p}A.k=p+1;A.KK=Q(A.K);A.kk=Q(A.k);if(p>11){A.a="PM"}else{A.a="AM"}A.m=B;A.mm=Q(B);A.s=t;A.ss=Q(t);A.S=f;A.SS=Q(f,2);A.SSS=Q(f,3);while(x<I.length){L=I.charAt(x);g="";while((I.charAt(x)==L)&&(x<I.length)){g+=I.charAt(x++)}if(A[g]!=null){o+=A[g]}else{o+=g}}return o},_isInteger:function(c){var b="1234567890";for(var a=0;a<c.length;a++){if(b.indexOf(c.charAt(a))==-1){return false}}return true},_getInt:function(f,d,e,c){for(var a=c;a>=e;a--){var b=f.substring(d,d+a);if(b.length<e){return null}if(Control.DatePicker.DateFormat._isInteger(b)){return b}}return null},parseFormat:function(D,t){var C=Control.DatePicker.DateFormat.LZ;var j=Control.DatePicker.DateFormat.MONTH_NAMES;var o=Control.DatePicker.DateFormat.DAY_NAMES;var z=Control.DatePicker.DateFormat._getInt;D=D+"";t=t+"";var B=0;var n=0;var u="";var f="";var A="";var h,g;var b=new Date();var l=b.getYear();var w=b.getMonth()+1;var v=1;var d=b.getHours();var s=b.getMinutes();var q=b.getSeconds();var k=b.getMilliseconds();var m="";while(n<t.length){u=t.charAt(n);f="";while((t.charAt(n)==u)&&(n<t.length)){f+=t.charAt(n++)}if(f=="yyyy"||f=="yy"||f=="y"){if(f=="yyyy"){h=4}g=4;if(f=="yy"){h=2}g=2;if(f=="y"){h=2}g=4;l=z(D,B,h,g);if(l==null){return 0}B+=l.length;if(l.length==2){if(l>70){l=1900+(l-0)}else{l=2000+(l-0)}}}else{if(f=="MMM"||f=="NNN"){w=0;for(var r=0;r<j.length;r++){var e=j[r];if(D.substring(B,B+e.length).toLowerCase()==e.toLowerCase()){if(f=="MMM"||(f=="NNN"&&r>11)){w=r+1;if(w>12){w-=12}B+=e.length;break}}}if((w<1)||(w>12)){return 0}}else{if(f=="EE"||f=="E"){for(var r=0;r<o.length;r++){var p=o[r];if(D.substring(B,B+p.length).toLowerCase()==p.toLowerCase()){B+=p.length;break}}}else{if(f=="MM"||f=="M"){w=z(D,B,f.length,2);if(w==null||(w<1)||(w>12)){return 0}B+=w.length}else{if(f=="dd"||f=="d"){v=z(D,B,f.length,2);if(v==null||(v<1)||(v>31)){return 0}B+=v.length}else{if(f=="hh"||f=="h"){d=z(D,B,f.length,2);if(d==null||(d<1)||(d>12)){return 0}B+=d.length}else{if(f=="HH"||f=="H"){d=z(D,B,f.length,2);if(d==null||(d<0)||(d>23)){return 0}B+=d.length}else{if(f=="KK"||f=="K"){d=z(D,B,f.length,2);if(d==null||(d<0)||(d>11)){return 0}B+=d.length}else{if(f=="kk"||f=="k"){d=z(D,B,f.length,2);if(d==null||(d<1)||(d>24)){return 0}B+=d.length;d--}else{if(f=="mm"||f=="m"){s=z(D,B,f.length,2);if(s==null||(s<0)||(s>59)){return 0}B+=s.length}else{if(f=="ss"||f=="s"){q=z(D,B,f.length,2);if(q==null||(q<0)||(q>59)){return 0}B+=q.length}else{if(f=="SS"||f=="S"||f=="SSS"){k=z(D,B,f.length,3);if(k==null||(k<0)||(k>999)){return 0}B+=k.length}else{if(f=="a"){if(D.substring(B,B+2).toLowerCase()=="am"){m="AM"}else{if(D.substring(B,B+2).toLowerCase()=="pm"){m="PM"}else{return 0}}B+=2}else{if(D.substring(B,B+f.length)!=f){return 0}else{B+=f.length}}}}}}}}}}}}}}}if(B!=D.length){return 0}if(w==2){if(((l%4==0)&&(l%100!=0))||(l%400==0)){if(v>29){return 0}}else{if(v>28){return 0}}}if((w==4)||(w==6)||(w==9)||(w==11)){if(v>30){return 0}}if(d<12&&m=="PM"){d=d-0+12}else{if(d>11&&m=="AM"){d-=12}}var a=new Date(l,w-1,v,d,s,q,k);return a},parse:function(b,k){if(k){return Control.DatePicker.DateFormat.parseFormat(b,k)}else{var m=["y-M-d","MMM d, y","MMM d,y","y-MMM-d","d-MMM-y","MMM d"];var c=["M/d/y","M-d-y","M.d.y","MMM-d","M/d","M-d"];var n=["d/M/y","d-M-y","d.M.y","d-MMM","d/M","d-M"];var a=[m,c,n];var h=null;for(var g=0;g<a.length;g++){var e=a[g];for(var f=0;f<e.length;f++){h=Control.DatePicker.DateFormat.parseFormat(b,e[f]);if(h!=0){return new Date(h)}}}return null}}});Protoplasm.register("datepicker",Control.DatePicker);if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize dialog")}if(typeof Effect=="undefined"){Protoplasm.useScriptaculous("effects")}var Dialog={active:null,close:function(){if(Dialog.active){Dialog.active.close()}},success:function(){if(Dialog.active){Dialog.active.success()}},failure:function(){if(Dialog.active){Dialog.active.failure()}}};Dialog.Base=Class.create({initialize:function(b,a){b=$(b);this.options=Object.extend({},a||{});this.createComponents();this.contents=$(b);this.dialog.appendChild(this.contents);this.keyListener=null;Object.extend(b,{show:this.show.bind(this),hide:this.close.bind(this),success:this.success.bind(this),failure:this.failure.bind(this)})},createComponents:function(){if(!this.overlay){this.overlay=new Element("div");this.overlay.setStyle({position:"fixed",top:0,left:0,zIndex:90,width:"100%",height:"100%",backgroundColor:"#000",display:"none"});document.body.appendChild(this.overlay);if(!this.options.ignoreClicks){this.overlay.on("click",this.close.bindAsEventListener(this))}}if(!this.dialog){this.dialog=new Element("div");this.dialog.setStyle({position:"fixed",display:"none",zIndex:91});console.log(this.options.height);if(this.options.width||this.options.height){this.dialog.style.overflow="auto";if(this.options.width){this.dialog.style.width=this.options.width+"px"}if(this.options.height){this.dialog.style.height=this.options.height+"px"}}if(this.options.dialogClass){this.dialog.addClassName(this.options.dialogClass)}document.body.appendChild(this.dialog)}},baseShow:function(){if(this.shown&&Dialog.active==this){return}Dialog.close();Dialog.active=this;if(typeof Effect=="undefined"){this.overlay.show();this.dialog.show()}else{new Effect.Appear(this.overlay,{duration:0.1,from:0,to:0.3});new Effect.Appear(this.dialog,{duration:0.1})}this.resize();this.keyListener=document.on("keydown",function(a){if(a.keyCode==Event.KEY_ESC){if(!this.options.ignoreEsc){this.close()}Event.stop(a)}if(!(Event.findElement(a,"#dialog_box")||a.shiftKey||a.altKey||a.metaKey||a.ctrlKey)){Event.stop(a)}}.bindAsEventListener(this));if(this.options.onOpen){this.options.onOpen(this.contents)}this.shown=true},show:function(){this.baseShow()},resize:function(){var d=Element.getDimensions(this.dialog);var b=Element.getDimensions(this.contents);var c=document.viewport.getDimensions();this.dialog.style.left=((c.width-d.width)/2)+"px";if(d.height>(c.height-100)){var a=d.height-b.height;this.dialog.style.top="50px";this.dialog.style.height=(c.height-100)+"px";this.contents.style.height=(c.height-100-a)+"px";this.contents.style.overflow="auto"}else{this.dialog.style.top=((c.height-d.height)/2)*0.7+"px"}},close:function(a){if(!this.shown){return}if(this.keyListener){this.keyListener.stop();this.keyListener=null}if(Dialog.active==this){Dialog.active=null}if(typeof Effect=="undefined"){this.overlay.hide();this.dialog.hide();if(this.options.onClose){this.options.onClose()}}else{new Effect.Fade(this.overlay,{duration:0.1});new Effect.Fade(this.dialog,{duration:0.1,afterFinish:function(){if(this.options.onClose){this.options.onClose()}}.bind(this)})}if(this.options.onClose){this.options.onClose(this.contents)}if(a){Event.stop(a)}this.shown=false},success:function(a){this.close();if(this.options.onSuccess){this.options.onSuccess(a,this.contents)}},failure:function(a){this.close();if(this.options.onFailure){this.options.onFailure(a,this.contents)}}});Dialog.HTML=Class.create(Dialog.Base,{initialize:function($super,b,a){if(Object.isString(b)){$super(new Element("div").update(b),a)}else{$super(b,a)}}});Dialog.Frame=Class.create(Dialog.Base,{initialize:function($super,e,c,b){var a=Object.isString(c)?new Element("div").update(c):c;var d=new Element("div",{"class":"_pp_dialog _pp_panel"});if(b&&b.height){d.style.height=b.height+"px";delete b.height}d.appendChild(new Element("div",{"class":"_pp_title"}).update(e));d.appendChild(a);$super(d,b)}});Dialog.Ajax=Class.create(Dialog.Base,{initialize:function($super,b,a){$super(new Element("div"),a);this.url=b},show:function(){var a='<div style="text-align: center; color: #999;">Loading...</div>';if(this.options.loadingIcon){a='<div style="text-align: center;"><img src="'+this.options.loadingIcon+'" /></div><br />'+a}this.contents.update(a);new Ajax.Updater(this.contents,this.url,{method:"get",onComplete:function(b){}});this.baseShow()}});Protoplasm.register("dialog",Dialog.HTML);if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize expander")}if(window.Control==undefined){Control={}}Control.Expander=Class.create({initialize:function(a,b){this._initialize(a,b)},_initialize:function(a,b){this.container=$(a);this.options=Object.extend({expandedClass:null,collapsedClass:null,hoverClass:null,triggerElement:null,onexpand:Prototype.emptyFunction,oncollapse:Prototype.emptyFunction},b||{});Element.cleanWhitespace(this.container);if(this.container.childNodes.length==2){this.title=this.container.childNodes[0];this.body=this.container.childNodes[1];this.trigger=this.options.triggerElement||this.title}if(!this.options.expand){this.collapse(true)}this.applyBehavior(this.trigger,this.body)},applyBehavior:function(b,a){b.onclick=function(c){if(this.expanded){this.collapse()}else{this.expand()}}.bindAsEventListener(this);b.onmouseover=this.hover.bindAsEventListener(this);b.onmouseout=this.restore.bindAsEventListener(this);b.onmousedown=function(c){return false}.bindAsEventListener(this);b.onselectstart=function(c){return false}.bindAsEventListener(this)},expand:function(){Element.removeClassName(this.title,this.options.collapsedClass);Element.addClassName(this.title,this.options.expandedClass);this.body.style.display="block";this.expanded=true;if(this.options.onexpand){this.options.onexpand(this)}},collapse:function(a){Element.removeClassName(this.title,this.options.expandedClass);Element.addClassName(this.title,this.options.collapsedClass);this.body.style.display="none";this.expanded=false;if(this.options.oncollapse&&!a){this.options.oncollapse(this)}},hover:function(){Element.addClassName(this.title,this.options.hoverClass)},restore:function(){Element.removeClassName(this.title,this.options.hoverClass)}});Protoplasm.register("expander",Control.Expander);if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize filechooser")}if(typeof Control=="undefined"){Control={}}Protoplasm.use("dialog");Protoplasm.use("upload");Protoplasm.loadStylesheet("filechooser.css","filechooser");Control.FileChooser=Class.create({initialize:function(b,d,a){this.element=$(b);if(fc=this.element.retrieve("filechooser")){fc.destroy()}this.options=a||{};var c=Protoplasm.base("filechooser");if(!this.options.icon){this.options.icon=c+"filechooser.png"}if(!this.options.fileImage){this.options.fileImage=c+"file.gif"}if(!this.options.directoryImage){this.options.directoryImage=c+"directory.gif"}if(!this.options.parentImage){this.options.parentImage=c+"parent.gif"}if(this.options.icon){this.element.style.background="url("+this.options.icon+") right center no-repeat #FFF";this.oldPadding=this.element.style.paddingRight;this.element.style.paddingRight="20px"}this.panel=new Control.FileChooser.Panel(d,Object.extend({openListener:this.fileSelected.bind(this),standalone:true,selectFile:this.element.value},this.options||{}));this.dialogOpen=false;this.dialog=this.panel.getElement();this.listeners=[this.element.on("click",this.toggle.bindAsEventListener(this)),this.element.on("blur",this.delayedHide.bindAsEventListener(this)),this.dialog.on("click",this.cancelHide.bindAsEventListener(this)),this.element.on("keydown",this.keyHandler.bindAsEventListener(this))];this.clickListener=null;this.keyListener=null;this.element.store("filechooser",this);this.destructor=Event.on(window,"unload",this.destroy.bind(this))},destroy:function(){this.hide();for(var a=0;a<this.listeners.length;a++){this.listeners[a].stop()}if(this.clickListener){this.clickListener.stop()}if(this.keyListener){this.keyListener.stop()}this.element.style.paddingRight=this.oldPadding;this.element.store("filechooser",null);this.destructor.stop()},fileSelected:function(a){if(a){this.element.value=a.url}this.hide()},toggle:function(){if(this.dialogOpen){this.hide()}else{this.show()}},show:function(){if(!this.dialogOpen){var c=Element.getDimensions(this.element);var a=Position.cumulativeOffset(this.element);var b=/MSIE/.test(navigator.userAgent)?(a[1]+c.height)+"px":(a[1]+c.height-1)+"px";this.dialog.style.top=b;this.dialog.style.left=a[0]+"px";if(this.element.value){this.panel.select(this.element.value)}else{this.panel.refresh()}document.body.appendChild(this.dialog);this.clickListener=document.on("click",this.documentClickHandler.bindAsEventListener(this));this.keyListener=document.on("keydown",this.escHandler.bindAsEventListener(this));this.dialogOpen=true}},delayedHide:function(a){this.hideTimeout=setTimeout(this.hide,100)},cancelHide:function(a){if(this.hideTimeout){clearTimeout(this.hideTimeout);this.hideTimeout=null}},hide:function(){if(this.dialogOpen){if(this.clickListener){this.clickListener.stop();this.clickListener=null}if(this.keyListener){this.keyListener.stop();this.keyListener=null}if(this.dialog.parentNode){Element.remove(this.dialog)}this.dialogOpen=false}},keyHandler:function(a){switch(a.keyCode){case Event.KEY_DOWN:this.show();break}},escHandler:function(a){switch(a.keyCode){case Event.KEY_ESC:this.hide();break}},documentClickHandler:function(b){var a=Event.element(b);var c=false;do{if(a==this.dialog||a==this.element||(Dialog.active&&(a==Dialog.active.contents||a==Dialog.active.overlay))){c=true}}while(a=a.parentNode);if(!c){this.hide()}}});Control.FileChooser.Panel=Class.create({initialize:function(a,b){this.fileLister=a||Prototype.emptyFunction;this.options=Object.extend({width:360,height:220,className:"",fileImage:"/images/icons/file.gif",directoryImage:"/images/icons/directory.gif",parentImage:"/images/icons/parent.gif",uploadProgress:false},b||{});this.uploadHandler=this.options.uploadProgress?this.showAdvancedUploadDialog.bind(this):this.showUploadDialog.bind(this);this.element=this.createFileChooser();if(this.options.selectFile){this.select(this.options.selectFile)}},getElement:function(){return this.element},createFileChooser:function(){var e=new Element("div");this.directoryHeader=new Element("div",{"class":"_pp_filechooser_directoryheader",style:"margin-bottom:5px;"}).update("&nbsp;");e.appendChild(this.directoryHeader);var k=new Element("table");k.cellSpacing=0;k.cellPadding=0;k.style.border=0;var l=k.insertRow(0);var f=this.options.height-40;var c=Math.round((this.options.width-6)*0.3);var d=this.options.height-61;var i=this.options.width-c-10;var j=l.insertCell(0);j.vAlign="top";this.fileList=new Element("div",{"class":"_pp_panel _pp_inset",style:"height:"+d+"px;width"+i+"px;overflow:auto;margin-right:3px;margin-bottom:5px;"});this.fileList.on("mousedown",function(){return false});this.fileList.on("selectstart",function(){return false});j.appendChild(this.fileList);this.createButton=new Element("input",{type:"button",value:"New Folder","class":"_pp_button",style:"margin-right:5px;width:"+Math.round((i-10)/3)+"px"});this.createButton.on("click",this.showDirectoryCreateDialog.bindAsEventListener(this));this.uploadButton=new Element("input",{type:"button",value:"New File","class":"_pp_button",style:"margin-right:5px;width:"+Math.round((i-10)/3)+"px"});this.uploadButton.on("click",function(m){this.uploadHandler(this)}.bindAsEventListener(this));this.deleteButton=new Element("input",{type:"button",value:"Delete","class":"_pp_button",style:"width:"+Math.round((i-10)/3)+"px"});this.deleteButton.on("click",this.showDeleteDialog.bindAsEventListener(this));var g=new Element("div");g.appendChild(this.createButton);g.appendChild(this.uploadButton);g.appendChild(this.deleteButton);j.appendChild(g);j=l.insertCell(1);j.vAlign="top";this.filePreview=new Element("div",{"class":"_pp_filechooser_preview _pp_inset",style:"height:"+f+"px;width:"+c+"px;margin-left:3px;margin-bottom:5px;overflow:hidden;position:relative"});j.appendChild(this.filePreview);e.appendChild(k);document.on("keydown",this.keyPressListener());if(this.options.standalone){var b=new Element("form");b.style.margin=0;var k=new Element("table");k.cellSpacing=0;k.cellPadding=0;k.border=0;var l=k.insertRow(0);var j=l.insertCell(0);this.fileLocation=new Element("input",{type:"text",readOnly:true,style:"width:245px;margin-right:5px"});j.appendChild(this.fileLocation);j=l.insertCell(1);j.style.textAlign="right";var h=new Element("input",{type:"button",value:"Cancel","class":"_pp_button",style:"width:50px;margin-right:5px;"});h.on("click",function(m){Element.remove(this.getElement())}.bindAsEventListener(this));j.appendChild(h);j=l.insertCell(2);j.style.textAlign="right";var h=new Element("input",{type:"button",value:"Select","class":"_pp_button",style:"width:50px;"});h.on("click",function(m){(this.options.openListener||Prototype.emptyFunction)(this.selectedFile)}.bindAsEventListener(this));j.appendChild(h);b.appendChild(k);e.appendChild(b);var a=new Element("div");a.style.position="absolute";a.appendChild(e);a.className="_pp_frame _pp_filechooser "+this.options.className;return a}else{e.className="_pp_frame _pp_filechooser "+this.options.className;return e}},select:function(b){this.filePreview.innerHTML="";this.fileList.innerHTML='<div style="padding:3px">Loading file list...</div>';this.selectedFile=null;var a=this.fileLister(null,this.selectByURL(b).bind(this));if(a){this.selectByURL(b)(a)}},selectByURL:function(a){return function(b){console.log(b);if(b.status!="error"&&a&&a.indexOf(b.url)==0){var d=a.substr(b.url.length);var c=d.substr(0,d.lastIndexOf("/"));this.pendingSelect=a;if(c!=b.path){this.refresh(c);return}}this.populateFileList(b)}.bind(this)},refresh:function(a){if(!a&&this.currentDirectory){a=this.currentDirectory.path}Dialog.close();this.filePreview.update();this.fileList.update('<div style="padding:3px">Loading file list...</div>');this.selectedFile=null;var b=this.fileLister(a,this.populateFileList.bind(this));if(b){this.populateFileList(b)}},populateFileList:function(b){if(b.status=="error"){this.fileList.update('<div style="padding:3px">Could not get directory contents.</div>');return}this.currentDirectory=b;this.entries=[];this.directoryHeader.update("<b>Folder:</b> "+(b.path||"/"));this.fileList.update();if(b.parent){this.entries[this.entries.length]={image:"parent",type:"directory",name:"Parent folder",path:b.parent}}if(b.files){if(b.files.constructor==Array){b.files.each(function(i){this.entries.push(i)}.bind(this))}else{this.entries.push(b.files)}}if(this.entries.length){var g=new Element("table");var a=null;g.cellSpacing=0;g.cellPadding=0;g.width="100%";g.style.border=3;this.entries.each(function(j){var i=this.createFileRow(j,g);if(this.pendingSelect&&this.pendingSelect==j.url){this.selectRow(j);a=i;this.pendingSelect=null}}.bind(this));this.fileList.appendChild(g);if(a){var f=g.offsetHeight;var c=this.fileList.offsetHeight;var d=a.offsetTop;var e=d+a.offsetHeight;if(e>c){var h=Math.round(d-(c/2));if(h+c>f){this.fileList.scrollTop=f-c}else{this.fileList.scrollTop=h}}}}else{this.fileList.update('<div style="padding:3px">To add items to your folder, please click <b>New Folder</b> or <b>New File</b> below.</div>')}if(b.fileManager){this.createButton.disabled=false;this.uploadButton.disabled=false}else{this.createButton.disabled=true;this.uploadButton.disabled=true}},showAdvancedUploadDialog:function(a){this.showUploadDialog(a,true)},showUploadDialog:function(j,a){var b=new Element("form",{method:"post",action:this.currentDirectory.fileManager,style:"padding: 12px;width:300px;"});var l=this.currentDirectory.path||"";b.appendChild(new Element("input",{type:"hidden",name:"a",value:"upload"}));b.appendChild(new Element("input",{type:"hidden",name:"p",value:(this.currentDirectory.path||"")}));var i=new Element("div",{style:"float:left;width:60px;padding-top:3px;"}).update("Files:");b.appendChild(i);var d=new Element("input",{type:"file",name:"i",multiple:"multiple"});b.appendChild(d);b.appendChild(new Element("br"));var h=new Element("div",{style:"float:right;"});var k=new Element("input",{type:"button",value:"Close","class":"_pp_button"});k.on("click",function(m){Dialog.close();Event.stop(m)}.bindAsEventListener(this));h.appendChild(k);h.appendChild(new Element("input",{type:"submit",value:"Upload Files","class":"_pp_button"}));b.appendChild(h);b.appendChild(new Element("div",{style:"clear:both;"}));var e=false;var f=new Control.FileUpload(d,{multiple:true,inline:true,batch:true,progress:a,includeFields:["a","p"],prependPath:l,onFailure:function(){e=true},onComplete:function(){if(!e){Dialog.close()}}.bind(this)});var c=new Element("div",{"class":"_pp_dialog _pp_panel"});c.appendChild(new Element("div",{"class":"_pp_title"}).update("Upload Files"));c.appendChild(b);var g=new Dialog.HTML(c,{onClose:function(){this.refresh()}.bind(this)});g.show()},showDeleteDialog:function(){var c=this.selectedFile.type=="directory"?"Are you sure you want to PERMANENTLY delete this folder\nand all files and folders in it?":"Are you sure you want to PERMANENTLY delete this file?";if(this.selectedFile&&confirm(c)){var b=this.currentDirectory.fileManager;var a={parameters:"a=delete&p="+(this.currentDirectory.path||"")+"&f="+this.selectedFile.name,onSuccess:function(d){this.refresh(this.currentDirectory.path)}.bindAsEventListener(this),onFailure:function(d){this.refresh(this.currentDirectory.path);alert(d.responseText)}.bindAsEventListener(this)};this.filePreview.innerHTML="";this.fileList.innerHTML="Loading file list...";new Ajax.Request(b,a)}},showDirectoryCreateDialog:function(){var a=prompt("Enter a folder name:","");if(a){this.createDirectory(a)}},createDirectory:function(c){var b=this.currentDirectory.fileManager;var a={parameters:"a=createdir&p="+(this.currentDirectory.path||"")+"&d="+c,onSuccess:this.createDirectorySuccessful.bind(this),onFailure:this.createDirectoryFailed.bind(this)};this.filePreview.innerHTML="";this.fileList.innerHTML="Loading file list...";new Ajax.Request(b,a)},createDirectorySuccessful:function(a){this.refresh(this.currentDirectory.path)},createDirectoryFailed:function(a){this.refresh(this.currentDirectory.path);alert(a.responseText)},showPreview:function(b){while(this.filePreview.firstChild){Element.remove(this.filePreview.firstChild)}var c=b.substring(b.lastIndexOf(".")+1);if(!c||!$w("jpeg jpg gif png bmp").include(c.toLowerCase())){return}var d=new Element("img");var a=false;d.onload=function(j){if(!a){a=true;var l=d.width;var k=d.height;var i=this.filePreview.offsetWidth-6;var h=this.filePreview.offsetHeight-6;var g=d.width/i;var f=d.height/h;if(g>1&&g>=f){d.width=Math.floor(d.width/g);d.height=Math.floor(d.height/g)}else{if(f>1){d.width=Math.floor(d.width/f);d.height=Math.floor(d.height/f)}}d.setStyle({position:"absolute",top:Math.round((h-d.height)/2)+"px",left:Math.round((i-d.width)/2)+"px",backgroundColor:"#FFFFFF",border:1});this.filePreview.appendChild(d);if(this.options.previewListener){this.options.previewListener(l,k)}}}.bindAsEventListener(this);d.onerror=function(f){while(this.filePreview.firstChild){Element.remove(this.filePreview.firstChild)}if(this.options.previewListener){this.options.previewListener("","")}}.bindAsEventListener(this);d.src=b},createFileRow:function(b,c){var e=c.insertRow(c.rows.length);var a=e.insertCell(0);a.className="_pp_filechooser_filerow";a.width=10;a.appendChild(new Element("img",{src:this.options[(b.image||b.type)+"Image"]}));a=e.insertCell(1);a.className="_pp_filechooser_filerow";a.appendChild(new Element("div",{style:"overflow:hidden;"}).update(b.name));a=e.insertCell(2);a.className="_pp_filechooser_filerow";a.align="right";if(b.size!==undefined){var d;if(b.type=="directory"){d=b.size+" items"}else{d=this.formatFileSize(b.size)}a.innerHTML="<nobr>"+d+"</nobr>"}else{a.innerHTML="&nbsp;"}e.onmousedown=this.fileSelectListener(b);if(b.type=="file"){e.ondblclick=this.fileOpenListener(b)}else{e.ondblclick=this.directoryOpenListener(b)}e.onselectstart=function(){return false};b.element=e;return e},formatFileSize:function(a){if(!a){a=0}if(a<1024){return a+" bytes"}else{if(a<1024*1024){return this.twoDecimals(a/1024)+" KB"}else{return this.twoDecimals(a/(1024*1024))+" MB"}}},twoDecimals:function(a){return Math.round(a*100)/100},fileSelectListener:function(a){return function(b){this.selectRow(a);return false}.bindAsEventListener(this)},directoryOpenListener:function(a){return function(b){this.refresh(a.path)}.bindAsEventListener(this)},fileOpenListener:function(a){return function(b){if(this.options.openListener){this.options.openListener(a)}}.bindAsEventListener(this)},keyPressListener:function(){return function(b){if(this.element.parentNode){switch(b.keyCode){case Event.KEY_DELETE:this.showDeleteDialog();break;case Event.KEY_RETURN:if(this.selectedFile){if(this.selectedFile.type=="file"){this.fileOpenListener(this.selectedFile)()}else{this.directoryOpenListener(this.selectedFile)()}}break;case Event.KEY_UP:var a=this.selectedIndex()-1;if(a<0){a=0}this.selectRow(this.entries[a]);break;case Event.KEY_DOWN:var a=this.selectedIndex()+1;if(a>=this.entries.length){a=this.entries.length-1}this.selectRow(this.entries[a]);break;case 33:var c=Math.floor(this.fileList.offsetHeight/this.entries[0].element.offsetHeight);var a=this.selectedIndex()-c;if(a<0){a=0}this.selectRow(this.entries[a]);break;case 34:var c=Math.floor(this.fileList.offsetHeight/this.entries[0].element.offsetHeight);var a=this.selectedIndex()+c;if(a>=this.entries.length){a=this.entries.length-1}this.selectRow(this.entries[a]);break;case 35:if(this.entries){this.selectRow(this.entries[this.entries.length-1])}break;case 36:if(this.entries){this.selectRow(this.entries[0])}break;default:return}Event.stop(b)}}.bindAsEventListener(this)},selectRow:function(a){if(this.selectedFile!=a){if(this.selectedFile){Element.removeClassName(this.selectedFile.element,"_pp_highlight")}this.selectedFile=a;Element.addClassName(a.element,"_pp_highlight");if(a.url){this.showPreview(a.url);if(this.options.standalone){this.fileLocation.value=a.url}if(this.options.selectListener){this.options.selectListener(a.url)}}else{this.showPreview("");if(this.options.selectListener){this.options.selectListener("")}}}if(a.element.offsetTop<this.fileList.scrollTop){this.fileList.scrollTop=a.element.offsetTop}else{if(a.element.offsetTop+a.element.offsetHeight>this.fileList.scrollTop+this.fileList.offsetHeight){this.fileList.scrollTop=(a.element.offsetTop+a.element.offsetHeight)-this.fileList.offsetHeight}}},selectedIndex:function(){for(index=0;index<this.entries.length;++index){if(this.entries[index]==this.selectedFile){return index}}return -1}});Protoplasm.register("filechooser",Control.FileChooser);if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize livegrid")}if(window.Control==undefined){Control={}}Protoplasm.loadStylesheet("livegrid.css","livegrid");Control.LiveGrid=Class.create({initialize:function(c,f,b,g,a){if(a==null){a={}}this.table=$(c);if(lg=this.table.retrieve("livegrid")){throw ("This table is already a Live Grid")}this.fetchHandler=g;this.sortField=a.sortField?a.sortField:null;this.sortDir=a.sortDir?a.sortDir:null;var d=this.table.rows[0].cells.length;this.metaData=new Control.LiveGrid.MetaData(f,b,d,a);this.buffer=new Control.LiveGrid.Buffer(this.metaData);this.viewPort=new Control.LiveGrid.ViewPort(this.table,this.buffer,this.metaData);this.scroller=new Control.LiveGrid.Scroller(this.viewPort,this.metaData,this.requestContentRefresh.bind(this));if(a.selectable){this.selector=new Control.LiveGrid.Selector(this.table,this.fetchHandler,this.metaData)}if(a.sortHeader){this.sorter=new Control.LiveGrid.Sort(a.sortHeader,this.metaData,this.sort.bind(this))}if(a.captureKeyEvents){this.captureKeys()}this.processingRequest=null;this.unprocessedRequest=null;if(a.prefetchBuffer||a.offset>0){var e=0;if(a.offset){e=a.offset;this.scroller.moveScroll(e);this.viewPort.scrollTo(this.scroller.rowToPixel(e))}this.requestContentRefresh(e)}this.table.store("livegrid",this)},resetContents:function(){this.scroller.unplug();this.scroller.moveScroll(0);this.scroller.plugin();this.buffer.clear();this.viewPort.clearContents()},captureKeys:function(){this.keyObserver=this.keyEvent.bindAsEventListener(this);Event.observe(window,"keypress",this.keyObserver)},releaseKeys:function(){Event.stopObserving(window,"keypress",this.keyObserver)},keyEvent:function(a){if(a.keyCode==Event.KEY_DOWN){this.moveSelection(a,1)}else{if(a.keyCode==Event.KEY_UP){this.moveSelection(a,-1)}else{if(a.keyCode==Event.KEY_RETURN&&a.shiftKey){this.selector.rowdblclickhandler()(a)}else{if(a.keyCode==33){this.moveSelection(a,-this.metaData.pageSize)}else{if(a.keyCode==34){this.moveSelection(a,this.metaData.pageSize)}}}}}},moveSelection:function(f,d){var g=this.metaData.totalRows-this.metaData.pageSize;if(g<0){g=0}if(this.selector){var b=(f.shiftKey&&this.selector.previousSelections!=null?this.selector.lastRangeSelected:this.selector.lastRowSelected);if(b==null){b=-1}if(b+d>=this.metaData.totalRows){d=(this.metaData.totalRows-b)-1}else{if(b+d<0){d=-b}}var c=this.selector.currentOffset;var a=b+d;if(a-c>=this.metaData.getPageSize()||a-c<0){var h=c+d;if(h>g){h=g;a=b+(g-h)}else{if(h<0){a=0;h=0}}this.scroller.moveScroll(h)}this.selector.rowmousedownhandler.bind(this.selector)(a-c)(f)}else{var c=parseInt(this.scroller.scrollerDiv.scrollTop/this.viewPort.rowHeight);var h=c+d;if(h>g){h=g}this.scroller.moveScroll(h)}},sort:function(b,a){this.sortField=b;this.sortDir=a;this.refresh()},refresh:function(){this.resetContents();this.requestContentRefresh(0);if(this.selector){this.selector.deselectAllRows()}},setTotalRows:function(a){this.metaData.setTotalRows(a);this.viewPort.setPageSize(this.metaData.getPageSize());this.scroller.updateSize();if(this.selector){this.selector.applyRowBehavior()}},handleTimedOut:function(){this.processingRequest=null;this.processQueuedRequest()},fetchBuffer:function(c){if(this.buffer.isInRange(c)&&!this.buffer.isNearingLimit(c)){return}if(this.processingRequest){this.unprocessedRequest=new Control.LiveGrid.Request(c);return}var b=this.buffer.getFetchOffset(c);this.processingRequest=new Control.LiveGrid.Request(c);this.processingRequest.bufferOffset=b;var a=this.buffer.getFetchSize(c);var d=false;this.fetchHandler(b,a,this.sortField,this.sortDir,this.updateData.bind(this));this.timeoutHandler=setTimeout(this.handleTimedOut.bind(this),20000)},requestContentRefresh:function(a){this.fetchBuffer(a)},updateData:function(a){try{clearTimeout(this.timeoutHandler);this.buffer.update(a,this.processingRequest.bufferOffset);this.viewPort.bufferChanged()}catch(b){}finally{this.processingRequest=null}this.processQueuedRequest()},processQueuedRequest:function(){if(this.unprocessedRequest!=null){this.requestContentRefresh(this.unprocessedRequest.requestOffset);this.unprocessedRequest=null}}});Control.LiveGrid.staticFetchHandler=function(c,b){var a=Control.LiveGrid.convertToLiveGridRows(c,b);return function(k,d,f,e,l){if(f){var h=-1;for(var g=0;g<b.length;++g){if(b[g]==f){h=g;break}}if(h>-1){a=a.sort(function(m,i){var n=m.columns[h];var o=i.columns[h];if(n<o){return(e.toLowerCase()=="desc"?1:-1)}else{if(n==o){return 0}else{if(n>o){return(e.toLowerCase()=="desc"?-1:1)}}}})}}if(k>=a.length){k=a.length-1}if(k+d>a.length){d=a.length-k}l(a.slice(k,k+d))}};Control.LiveGrid.convertToLiveGridRows=function(d,c){var e=Array();if(d.length){for(var b=0;b<d.length;++b){e[b]={id:d[b].id,columns:new Array()};for(var a=0;a<c.length;++a){e[b].columns[a]=d[b][c[a]]}}}else{e[0]={id:d.id,columns:new Array()};for(var a=0;a<c.length;++a){e[0].columns[a]=d[c[a]]}}return e};Control.LiveGrid.MetaData=Class.create({initialize:function(a,c,d,b){this.pageSize=a;this.totalRows=c;this.setOptions(b);this.scrollArrowHeight=16;this.columnCount=d},setOptions:function(a){this.options=Object.extend({largeBufferSize:7,nearLimitFactor:0.2},a||{})},getPageSize:function(){return this.totalRows<this.pageSize?this.totalRows:this.pageSize},getTotalRows:function(){return this.totalRows},setTotalRows:function(a){this.totalRows=a},getLargeBufferSize:function(){return parseInt(this.options.largeBufferSize*this.pageSize)},getLimitTolerance:function(){return parseInt(this.getLargeBufferSize()*this.options.nearLimitFactor)}});Control.LiveGrid.Scroller=Class.create({initialize:function(b,a,c){this.metaData=a;this.viewPort=b;this.scrollHandler=c;this.isIE=navigator.userAgent.toLowerCase().indexOf("msie")>=0;this.createScrollBar();this.scrollTimeout=null;this.rows=new Array()},isUnPlugged:function(){return this.scrollerDiv.onscroll==null},plugin:function(){this.scrollerDiv.onscroll=this.handleScroll.bindAsEventListener(this)},unplug:function(){this.scrollerDiv.onscroll=null},createScrollBar:function(){var a=this.viewPort.visibleHeight();this.scrollerDiv=document.createElement("div");var b=this.scrollerDiv.style;b.position="relative";b.left=this.isIE?"-6px":"-3px";b.width="19px";b.height=a+"px";b.overflow="auto";this.heightDiv=document.createElement("div");this.heightDiv.style.width="1px";this.heightDiv.style.height=parseInt(a*this.metaData.getTotalRows()/this.metaData.getPageSize())+"px";this.scrollerDiv.appendChild(this.heightDiv);var c=this.viewPort.table;c.parentNode.parentNode.insertBefore(this.scrollerDiv,c.parentNode.nextSibling);setTimeout(this.plugin.bind(this))},updateSize:function(){var b=this.viewPort.table;var a=this.viewPort.visibleHeight();this.scrollerDiv.style.height=a+"px";if(this.metaData.getPageSize()==0){this.heightDiv.style.height=0}else{this.heightDiv.style.height=parseInt(a*this.metaData.getTotalRows()/this.metaData.getPageSize())+"px"}},rowToPixel:function(a){return(a/this.metaData.getTotalRows())*this.heightDiv.offsetHeight},moveScroll:function(a){var b=this.metaData.totalRows==0?0:a;if(this.metaData.options.onbeforescroll){this.metaData.options.onbeforescroll(a,this.metaData.getPageSize(),this.metaData.totalRows)}this.scrollerDiv.scrollTop=this.rowToPixel(a);if(this.metaData.options.onscroll){this.metaData.options.onscroll(a,this.metaData.getPageSize(),this.metaData.totalRows)}},handleScroll:function(){if(this.scrollTimeout){clearTimeout(this.scrollTimeout)}var a=parseInt(this.scrollerDiv.scrollTop/this.viewPort.rowHeight);if(this.metaData.options.onbeforescroll){this.metaData.options.onbeforescroll(a,this.metaData.getPageSize(),this.metaData.totalRows)}this.scrollHandler(a);this.viewPort.scrollTo(this.scrollerDiv.scrollTop);if(this.metaData.options.onscroll){this.metaData.options.onscroll(a,this.metaData.getPageSize(),this.metaData.totalRows)}this.scrollTimeout=setTimeout(this.scrollIdle.bind(this),1200)},scrollIdle:function(){if(this.metaData.options.onscrollidle){this.metaData.options.onscrollidle()}}});Control.LiveGrid.Buffer=Class.create({initialize:function(a,b){this.startPos=0;this.size=0;this.metaData=a;this.rows=new Array();this.updateInProgress=false;this.viewPort=b;this.maxBufferSize=a.getLargeBufferSize()*2;this.maxFetchSize=a.getLargeBufferSize();this.lastOffset=0},getBlankRow:function(){if(!this.blankRow){this.blankRow=new Array();for(var a=0;a<this.metaData.columnCount;a++){this.blankRow[a]="&nbsp;"}}return this.blankRow},fixRows:function(a){for(var c=0;c<a.length;++c){for(var b=0;b<a[c].columns.length;++b){if(!a[c].columns[b]){a[c].columns[b]="&nbsp;"}}}return a},update:function(a,d){var b=this.fixRows(a);if(this.rows.length==0){this.rows=b;this.size=this.rows.length;this.startPos=d;return}if(d>this.startPos){if(this.startPos+this.rows.length<d){this.rows=b;this.startPos=d}else{this.rows=this.rows.concat(b.slice(0,b.length));if(this.rows.length>this.maxBufferSize){var c=this.rows.length;this.rows=this.rows.slice(this.rows.length-this.maxBufferSize,this.rows.length);this.startPos=this.startPos+(c-this.rows.length)}}}else{if(d+b.length<this.startPos){this.rows=b}else{this.rows=b.slice(0,this.startPos).concat(this.rows);if(this.rows.length>this.maxBufferSize){this.rows=this.rows.slice(0,this.maxBufferSize)}}this.startPos=d}this.size=this.rows.length},clear:function(){this.rows=new Array();this.startPos=0;this.size=0},isOverlapping:function(b,a){return((b<this.endPos())&&(this.startPos<b+a))||(this.endPos()==0)},isInRange:function(a){return(a>=this.startPos)&&(a+this.metaData.getPageSize()<=this.endPos())},isNearingTopLimit:function(a){return a-this.startPos<this.metaData.getLimitTolerance()},endPos:function(){return this.startPos+this.rows.length},isNearingBottomLimit:function(a){return this.endPos()-(a+this.metaData.getPageSize())<this.metaData.getLimitTolerance()},isAtTop:function(){return this.startPos==0},isAtBottom:function(){return this.endPos()==this.metaData.getTotalRows()},isNearingLimit:function(a){return(!this.isAtTop()&&this.isNearingTopLimit(a))||(!this.isAtBottom()&&this.isNearingBottomLimit(a))},getFetchSize:function(c){var a=this.getFetchOffset(c);var b=0;if(a>=this.startPos){var d=this.maxFetchSize+a;if(d>this.metaData.totalRows){d=this.metaData.totalRows}b=d-a}else{var b=this.startPos-a;if(b>this.maxFetchSize){b=this.maxFetchSize}}return b},getFetchOffset:function(b){var a=b;if(b>this.startPos){a=(b>this.endPos())?b:this.endPos()}else{if(b+this.maxFetchSize>=this.startPos){var a=this.startPos-this.maxFetchSize;if(a<0){a=0}}}this.lastOffset=a;return a},getRows:function(g,e){var f=g-this.startPos;var b=f+e;if(b>this.size){b=this.size}var d=new Array();var a=0;for(var c=f;c<b;c++){d[a++]=this.rows[c]}return d},convertSpaces:function(a){return a.split(" ").join("&nbsp;")}});Control.LiveGrid.ViewPort=Class.create({initialize:function(c,b,a){this.metaData=a;this.table=c;this.buffer=b;this.setPageSize(a.getPageSize());this.rowTemplate=null;this.lastDisplayedStartPos=0;this.lastPixelOffset=0;this.startPos=0},setPageSize:function(a){this.fillTableRows(this.table,a);this.div=this.table.parentNode;this.rowHeight=a>0?this.table.offsetHeight/a:1;this.div.style.height=this.table.offsetHeight+"px";this.div.style.overflow="hidden";this.visibleRows=a>0?a+1:0;this.fillTableRows(this.table,this.visibleRows);this.setOddOrEven(this.table,0)},fillTableRows:function(d,e){if(d.rows.length||this.rowTemplate){if(!this.rowTemplate){this.rowTemplate=d.rows[0];for(var c=0;c<this.rowTemplate.cells.length;++c){if(!this.rowTemplate.cells[c].innerHTML){this.rowTemplate.cells[c].innerHTML="&nbsp;"}}}while(d.rows.length<e){var b=d.insertRow(d.rows.length);b.className=this.rowTemplate.className;for(j=0;j<this.rowTemplate.cells.length;++j){var a=b.insertCell(b.cells.length);if(this.rowTemplate.cells[j].className){a.className=this.rowTemplate.cells[j].className}if(this.rowTemplate.cells[j].width){a.width=this.rowTemplate.cells[j].width}if(this.rowTemplate.cells[j].style.width){a.style.width=this.rowTemplate.cells[j].style.width}a.innerHTML="&nbsp;"}}while(d.rows.length>e){d.deleteRow(d.rows.length-1)}}},setOddOrEven:function(b,c){for(var a=0;a<b.rows.length;++a){if(a%2==1){Element.removeClassName(b.rows[a],"even");Element.addClassName(b.rows[a],"odd")}else{Element.removeClassName(b.rows[a],"odd");Element.addClassName(b.rows[a],"even")}}},populateRow:function(e,d){var a=e.cells.length;var c=d.columns?d.columns:d;if(d.id){e.id=this.metaData.options.rowIdPrefix?this.metaData.options.rowIdPrefix+d.id:d.id}for(var b=0;b<a;b++){e.cells[b].innerHTML=c[b]}},bufferChanged:function(){this.refreshContents(parseInt(this.lastPixelOffset/this.rowHeight))},clearRows:function(){if(!this.isBlank){for(var a=0;a<this.visibleRows;a++){this.populateRow(this.table.rows[a],this.buffer.getBlankRow())}this.isBlank=true}},clearContents:function(){this.clearRows();this.scrollTo(0);this.startPos=0;this.lastStartPos=-1},refreshContents:function(g){if(g==this.lastRowPos&&!this.isPartialBlank&&!this.isBlank){return}if((g+this.visibleRows<this.buffer.startPos)||(this.buffer.startPos+this.buffer.size<g)||(this.buffer.size==0)){this.clearRows();return}this.isBlank=false;var f=this.buffer.startPos>g;var b=f?this.buffer.startPos:g;var a=(this.buffer.startPos+this.buffer.size<g+this.visibleRows)?this.buffer.startPos+this.buffer.size:g+this.visibleRows;var k=a-b;var l=this.buffer.getRows(b,k);var d=this.visibleRows-k;var h=f?0:k;var c=f?d:0;for(var e=0;e<l.length;e++){this.populateRow(this.table.rows[e+c],l[e])}for(var e=0;e<d;e++){this.populateRow(this.table.rows[e+h],this.buffer.getBlankRow())}this.isPartialBlank=d>0;this.lastRowPos=g},scrollTo:function(a){if(this.lastPixelOffset==a){return}this.refreshContents(parseInt(a/this.rowHeight));this.div.scrollTop=a%this.rowHeight;this.lastPixelOffset=a},visibleHeight:function(){return parseInt(this.div.style.height)}});Control.LiveGrid.Request=Class.create({initialize:function(b,a){this.requestOffset=b}});Control.LiveGrid.Selector=Class.create({initialize:function(b,c,a){this.table=b;this.fetchHandler=c;this.metaData=a;this.lastRowSelected=null;this.lastRangeSelected=null;this.rowIdPrefix=(a.options.rowIdPrefix?a.options.rowIdPrefix:"");this.selectedClass=(a.options.selectedClass?a.options.selectedClass:"selected");this.onrowselect=a.options.onrowselect;this.onrowopen=a.options.onrowopen;this.currentOffset=a.options.offset?a.options.offset:0;a.options.onbeforescroll=this.handleScroll.bind(this);this.selections=Array();this.previousSelections=Array();this.applyRowBehavior()},applyRowBehavior:function(){for(var a=0;a<this.table.rows.length;++a){this.table.rows[a].onmousedown=this.rowmousedownhandler(a);this.table.rows[a].onmousemove=this.rowmousemovehandler(a);this.table.rows[a].onmouseup=this.rowmouseuphandler();this.table.rows[a].ondblclick=this.rowdblclickhandler();this.table.rows[a].onselectstart=function(){return false}}},rowmousedownhandler:function(a){return function(b){this.dragging=true;this.onrowclick(a,b);if(this.onrowselect){this.onrowselect(b,this)}Event.stop(b);return false}.bindAsEventListener(this)},rowmousemovehandler:function(a){return function(b){if(this.dragging){this.onrowclick(a,b,true);if(this.onrowselect){this.onrowselect(b,this)}}return false}.bindAsEventListener(this)},rowmouseuphandler:function(a){return function(b){this.dragging=false}.bindAsEventListener(this)},rowdblclickhandler:function(){return function(a){if(this.onrowopen){this.onrowopen(a,this)}Event.stop(a)}.bindAsEventListener(this)},onrowclick:function(b,f,a){var d=this.table.rows[b].id;var g=this.currentOffset+b;if(f.shiftKey||a){if(!this.previousSelections){this.previousSelections=this.copyArray(this.selections)}else{this.selections=this.copyArray(this.previousSelections)}if(this.lastRowSelected<g){for(var c=this.lastRowSelected;c<=g;++c){this.selections[c]=this.table.rows[c-this.currentOffset].id}}else{if(this.lastRowSelected>g){for(var c=this.lastRowSelected;c>=g;--c){this.selections[c]=this.table.rows[c-this.currentOffset].id}}}this.lastRangeSelected=g}else{if(f.ctrlKey){this.selections[g]=this.selections[g]?null:d;this.lastRowSelected=g;this.previousSelections=null}else{this.deselectAllRows(true);this.selections[g]=d;this.lastRowSelected=g;this.previousSelections=null}}this.redrawSelections()},copyArray:function(a){var b=new Array(a.length);for(var c=0;c<a.length;++c){b[c]=a[c]}return b},selectedRows:function(){var b=new Array();var c=(this.rowIdPrefix?this.rowIdPrefix.length:0);for(var a=0;a<this.selections.length;++a){if(this.selections[a]){b[b.length]=this.selections[a].substring(c)}}return b},handleScroll:function(c,a,b){this.currentOffset=c;this.redrawSelections()},selectAllRows:function(){alert("Not implemented");if(this.onrowselect){this.onrowselect(null,this)}},deselectAllRows:function(a){this.selections=new Array();this.redrawSelections();this.lastRowSelected=null;this.previousSelections=null;if(this.onrowselect){this.onrowselect(null,this)}},redrawSelections:function(b){b=b?b:this.currentOffset;for(var a=0;a<this.table.rows.length;++a){if(b+a<this.metaData.totalRows){if(this.selections[b+a]){Element.addClassName(this.table.rows[a],this.selectedClass)}else{Element.removeClassName(this.table.rows[a],this.selectedClass)}}}}});Control.LiveGrid.Sort=Class.create({initialize:function(c,b,a){this.table=$(c);this.sortHandler=a;this.setOptions(b.options);this.columns=this.table.rows[0].cells;this.applySortBehavior(this.columns);this.initSortColumn()},initSortColumn:function(){var a=this.options.sortField;if(a){var c=this.options.sortDirection?this.options.sortDirection:"asc";for(var b=0;b<this.columns.length;++b){if(this.columns[b].getAttribute("sortField")==a){this.setSortColumn(this.columns[b],c)}}}},setOptions:function(a){var b=Protoplasm.base("livegrid");var c={sortAscendImg:b+"sort_asc.png",sortDescendImg:b+"sort_desc.png",imageWidth:9,imageHeight:5};this.options=Object.extend(c,a);new Image().src=this.options.sortAscendImg;new Image().src=this.options.sortDescendImg},applySortBehavior:function(a){for(var b=0;b<a.length;++b){if(this.isSortable(b)){var c=this.options.sortFields?this.options.sortFields[b]:a[b].id;a[b].setAttribute("sortField",c);a[b].style.cursor="pointer";a[b].onclick=this.onclick.bindAsEventListener(this);a[b].innerHTML+='<span id="'+c+'_img">&nbsp;&nbsp;&nbsp;</span>'}}},isSortable:function(a){return(!this.options.sortFields||this.options.sortFields[a])},onclick:function(b){var a=Event.element(b);while(a.tagName.toUpperCase()!="TD"&&a.tagName.toUpperCase()!="TH"){a=a.parentNode}this.setSortColumn(a);this.executeSort()},setSortColumn:function(a,b){if(a.getAttribute("sortField")==this.sortField){this.sortDirection=(this.sortDirection=="asc"?"desc":"asc")}else{this.sortField=a.getAttribute("sortField");this.sortDirection="asc"}this.refreshColumnDisplay()},refreshColumnDisplay:function(){for(var a=0;a<this.columns.length;++a){if(this.columns[a].onclick){var b=$(this.columns[a].getAttribute("sortField")+"_img");if(this.columns[a].getAttribute("sortField")==this.sortField){if(this.sortDirection=="asc"){b.innerHTML='&nbsp;&nbsp;<img width="'+this.options.imageWidth+'" height="'+this.options.imageHeight+'" src="'+this.options.sortAscendImg+'"/>'}else{if(this.sortDirection=="desc"){b.innerHTML='&nbsp;&nbsp;<img width="'+this.options.imageWidth+'" height="'+this.options.imageHeight+'" src="'+this.options.sortDescendImg+'"/>'}else{b.innerHTML="&nbsp;&nbsp;"}}}else{b.innerHTML="&nbsp;&nbsp;"}}}},executeSort:function(){this.sortHandler(this.sortField,this.sortDirection)}});Protoplasm.register("livegrid",Control.LiveGrid);if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize ratingbar")}if(window.Control==undefined){Control={}}Protoplasm.loadStylesheet("rating.css","ratingbar");Control.RatingBar=Class.create({initialize:function(b,a){this.element=$(b);this.stars=[];this.options=Object.extend({min:1,max:5,rating:0,starClass:"rating_star",onClass:"rating_on",halfClass:"rating_half",hoverClass:"rating_hover",waitForUpdate:false,onclick:Prototype.K,onhover:Prototype.K},a||{});this.rating=this.options.rating;this.loading=document.createElement("div");this.loading.className="rating_loading";this.animating=false;this.createRatingBar();this.element.onmouseout=function(){if(!this.animating){this.resetRating()}}.bind(this)},createRatingBar:function(){this.element.cleanWhitespace();this.element.style.height="20px";if(this.element.childNodes.length==1&&this.element.firstChild.nodeType==3){this.rating=this.element.firstChild.nodeValue;this.element.removeChild(this.element.firstChild)}if(!this.element.childNodes.length){for(var a=this.options.min;a<=this.options.max;++a){var b=new Element("div");b.addClassName(this.options.starClass);this.element.appendChild(b)}}else{this.rating=this.options.min;for(var a=1;a<this.element.childNodes.length;++a){var c=$(this.element.childNodes[a]);if(c.hasClassName(this.options.onClass)){this.rating++}else{if(c.hasClassName(this.options.halfClass)){this.rating+=0.5}}}}for(var a=0;a<this.element.childNodes.length;++a){var c=$(this.element.childNodes[a]);if(c.hasClassName(this.options.starClass)){this.setStarBehavior(c,a+this.options.min);this.stars.push(c)}}if(this.options.rating){this.rating=this.options.rating}if(this.rating){this.showRating(this.rating)}},setStarBehavior:function(b,a){b.onmouseover=this.hoverRating.bind(this,a);b.onclick=this.doRating.bind(this,a)},hoverRating:function(b){b=Math.ceil(b);for(var a=0;a<this.stars.length;++a){this.stars[a].className=this.options.starClass;var c=a+this.options.min;if(c<=b){this.stars[a].addClassName(this.options.hoverClass)}}if(this.options.onhover){this.options.onhover(this)}},doRating:function(a){this.rating=a;this.animateBar(a,1,150,this.resetRating.bind(this));if(this.options.onclick){this.options.onclick(this)}},animateBar:function(d,f,c,a,e,b){this.animating=true;if(!e){e=0}if(e<f){if(b){this.hoverRating(d);e++}else{this.showRating(d)}setTimeout(this.animateBar.bind(this,d,f,c,a,e,!b),c)}else{if(e>=f){setTimeout(function(){this.animating=false;a()}.bind(this),500)}}},showRating:function(b){for(var a=0;a<this.stars.length;++a){this.stars[a].className=this.options.starClass;var c=a+this.options.min;if(c<=b){this.stars[a].addClassName(this.options.onClass)}else{if(c-0.5<=b){this.stars[a].addClassName(this.options.halfClass)}}}},resetRating:function(){if(!this.animating){this.showRating(this.rating);if(this.options.input){$(this.options.input).value=this.rating}}},setLoading:function(a){if(a){if(!this.loading.parentNode){this.element.appendChild(this.loading)}}else{$(this.loading).remove()}}});Protoplasm.register("ratingbar",Control.RatingBar);if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize rte")}if(typeof Control=="undefined"){Control={}}Protoplasm.use("colorpicker");Protoplasm.use("filechooser");Protoplasm.loadStylesheet("rte.css","rte");Control.RTE=Class.create();Object.extend(Control.RTE,{activeEditor:null,useEffects:false,dialogElement:null,includePath:null,initialized:false,editors:{},init:function(){if(!Control.RTE.initialized){Control.RTE.Dialog.cache={ColorPalette:new Control.RTE.Dialog.ColorPalette(),InsertLink:new Control.RTE.Dialog.InsertLink(),ImageBrowser:new Control.RTE.Dialog.ImageBrowser(),InsertTable:new Control.RTE.Dialog.InsertTable()}}},createElement:function(d,a,c,f){var b=null;try{b=document.createElement(d);if(a){for(att in a){b.setAttribute(att,a[att])}}if(c){b.className=c}if(f){Element.setStyle(b,f)}}catch(g){alert("Could not create element.")}return b}});Control.RTE.prototype={initialize:function(a,b){if(!Control.RTE.initialized){Control.RTE.init()}this.textarea=$(a);if(ta=this.textarea.retrieve("editor")){ta.destroy()}this.options=b||{};if(this.options.includePath){if(!/\/$/.test(includePath)){includePath+="/"}Control.RTE.includePath=includePath||""}else{Control.RTE.includePath=Protoplasm.base("rte")+"images/"}this.toolbarStyle=this.options.toolbarStyle;this.useXHTML=this.options.useXHTML;this.fileLister=this.options.fileLister;this.editorCss=this.options.editorCss;this.disableSourceView=this.options.disableSourceView;this.editorDiv=null;this.toolbar=null;this.iframe=null;this.iframeDiv=null;this.isEnabled=false;this.sourceCheckbox=null;this.inSourceView=false;this.activeDialog=null;this.selectedRange=null;this.keyPressListener=this.keyPressHandler.bindAsEventListener(this);this.cancelKeyPressListener=this.cancelKeyPressHandler.bindAsEventListener(this);this.keyUpListener=this.keyUpHandler.bindAsEventListener(this);this.clickListener=this.updateToolbarState.bindAsEventListener(this);this.closeDialogListener=this.closeDialog.bindAsEventListener(this);this.escKeyListener=this.escKeyPressed.bindAsEventListener(this);this.iframeTabListener=this.tabKeyPressed.bindAsEventListener(this);this.focusListener=this.focus.bindAsEventListener(this);this.changeListener=this.syncToEditor.bindAsEventListener(this);this.submitListener=function(d){this.syncToTextarea();return true}.bindAsEventListener(this);var c=navigator.userAgent.toLowerCase();this.isIE=((c.indexOf("msie")!=-1)&&(c.indexOf("opera")==-1)&&(c.indexOf("webtv")==-1));this.isGecko=(c.indexOf("gecko")!=-1);this.createEditor();this.destructor=Event.on(window,"unload",this.destroy.bind(this))},createEditor:function(){var b=this.textarea.parentNode;var c=this.textarea.offsetWidth?this.textarea.offsetWidth+"px":this.textarea.style.width;var l=this.textarea.offsetHeight?this.textarea.offsetHeight+"px":this.textarea.style.height;var g=document.createElement("div");if(c){g.style.width=c}this.toolbar=new Control.RTE.Toolbar(this,this.toolbarStyle);if(this.options.variables){this.toolbar.add(new Control.RTE.ToolbarLineBreak());this.toolbar.add(new Control.RTE.ToolbarVariableList("varlist",this.options.variables,"Insert Field",this.options.variableClass))}var h=document.createElement("div");h.className="rteEditor";this.iframeDiv=h;var k=document.createElement("div");k.style.borderTop="1px solid #999999";if(!this.disableSourceView){k.className="rteFooter";var f=document.createElement("input");f.type="checkbox";f.id=this.textarea.name+"_viewsource";f.onclick=this.toggleSourceView.bindAsEventListener(this);this.sourceCheckbox=f;k.appendChild(f);var j=document.createElement("label");j.htmlFor=f.id;j.innerHTML="View HTML Source - ";k.appendChild(j);clearFormatting=document.createElement("span");clearFormatting.onclick=function(i){if(confirm("Are you sure you want to clear all text formatting?")){this.clearFormatting()}return false}.bindAsEventListener(this);clearFormatting.innerHTML="Clear All Formatting";clearFormatting.style.textDecoration="underline";clearFormatting.style.color="blue";clearFormatting.style.cursor="pointer";k.appendChild(clearFormatting)}g.appendChild(this.toolbar.element);g.appendChild(h);g.appendChild(k);this.editorDiv=g;Element.hide(this.textarea);b.insertBefore(g,this.textarea);var d=document.createElement("iframe");d.width="100%";if(l){if(g.offsetHeight>0){d.height=parseInt(l)-g.offsetHeight}else{d.height=parseInt(l)-83}}d.style.border=0;d.style.margin=0;this.iframe=d;h.appendChild(d);this.createEditDoc();Event.observe(this.getIframeWindow().document,"click",this.closeDialogListener);Event.observe(document,"keypress",this.escKeyListener);Control.RTE.activeEditor=this;if(document.all){this.iframe.tabIndex=this.textarea.tabIndex}else{var e;var a=this.textarea.form.elements;for(e=0;e<a.length;++e){if(a[e]==this.textarea){break}if(!a[e].hidden){this.prevElement=a[e]}}if(a.length>e+1){this.nextElement=a[e+1]}if(this.prevElement){Event.observe(this.prevElement,"keypress",function(i){if(i.keyCode==Event.KEY_TAB&&!i.shiftKey){this.focus();return false}}.bindAsEventListener(this))}if(this.nextElement){Event.observe(this.nextElement,"keypress",function(i){if(i.keyCode==Event.KEY_TAB&&i.shiftKey){this.focus();return false}}.bindAsEventListener(this))}Event.observe(this.getIframeWindow().document,"keypress",this.iframeTabListener,true)}Event.observe(this.textarea,"change",this.changeListener);Event.observe(this.textarea,"focus",this.focusListener);Event.observe(this.textarea.form,"submit",this.submitListener);this.textarea.store("editor",this);return true},tabKeyPressed:function(a){if(a.keyCode==Event.KEY_TAB){this.moveFocus(a.shiftKey?this.prevElement:this.nextElement);Event.stop(a)}},focus:function(a){this.textarea.blur();this.getIframeWindow().focus()},moveFocus:function(a){if(a){if(a.editor){a.editor.focus.bind(a.editor)()}else{a.focus()}}},destroy:function(){Event.stopObserving(document,"keypress",this.escKeyListener);Event.stopObserving(this.textarea.form,"submit",this.submitListener);Event.stopObserving(this.textarea,"change",this.changeListener);Event.stopObserving(this.textarea,"focus",this.focusListener);var a=this.getIframeWindow().document;Event.stopObserving(a,"keypress",this.iframeTabListener,true);Event.stopObserving(a,"click",this.closeDialogListener);Event.stopObserving(a,"keypress",this.keyPressListener,true);Event.stopObserving(a,"keyup",this.keyUpListener,true);Event.stopObserving(a,"click",this.clickListener,true);Element.remove(this.editorDiv);this.editorDiv=null;this.iframe=null;this.sourceCheckbox=null;this.destructor.stop();this.textarea.store("editor",null);Element.show(this.textarea)},enable:function(){if(!this.isEnabled){try{var b=this.iframe.contentWindow.document;b.designMode="On";this.toolbar.enable();this.updateToolbarState();Event.stopObserving(b,"keypress",this.cancelKeyPressListener,true);Event.observe(b,"keypress",this.keyPressListener,true);Event.observe(b,"keyup",this.keyUpListener,true);Event.observe(b,"click",this.clickListener,true);if(this.sourceCheckbox){this.sourceCheckbox.disabled=false}this.isEnabled=true}catch(a){if(this.isGecko){setTimeout(this.enable.bind(this),10)}return false}}},disable:function(){if(this.isEnabled){var a=this.iframe.contentWindow.document;a.designMode="Off";this.toolbar.disable();Event.stopObserving(a,"keypress",this.keyPressListener,true);Event.stopObserving(a,"keyup",this.keyUpListener,true);Event.stopObserving(a,"click",this.clickListener,true);Event.observe(a,"keypress",this.cancelKeyPressListener,true);if(this.sourceCheckbox){this.sourceCheckbox.disabled=true}this.isEnabled=false}},createEditDoc:function(){var a=this.iframe.contentWindow.document;a.open();a.write(this.getEditorDoc(this.markupVariables(this.textarea.value),this.editorCss));a.close();this.enable()},updateToolbarState:function(){this.toolbar.refresh()},clearSelection:function(){var b=this.getIframeWindow();if(document.all){var a=b.document.selection;a.empty()}else{var a=b.getSelection();a.removeAllRanges()}this.selectedRange=null},getSelectedText:function(){if(this.selectedRange){if(this.isIE){return new String(this.selectedRange.htmlText).stripTags()}else{return this.selectedRange.toString().stripTags()}}return""},closeDialog:function(a){Control.RTE.Dialog.destroyActive()},showDialog:function(b,d){if(this.activeDialog==b){Control.RTE.Dialog.closeActive();return}var c=this.getIframeWindow();if(document.all){var a=c.document.selection;if(a){this.selectedRange=a.createRange()}}else{var a=c.getSelection();if(a&&a.rangeCount>0){this.selectedRange=a.getRangeAt(a.rangeCount-1).cloneRange()}}switch(b){case"textcolor":case"bgcolor":Control.RTE.Dialog.activate("ColorPalette",this,Event.element(d));break;case"link":Control.RTE.Dialog.activate("InsertLink",this,Event.element(d));break;case"image":Control.RTE.Dialog.activate("ImageBrowser",this,null,{fileLister:this.fileLister});break;case"table":Control.RTE.Dialog.activate("InsertTable",this,Event.element(d));break;default:new Control.RTE.Dialog(this,Event.element(d))}Control.RTE.activeEditor=this;this.activeDialog=b},setDialogColor:function(a){if(document.all&&this.selectedRange){this.selectedRange.select()}if(this.activeDialog=="textcolor"){this.doCommand("forecolor",a)}else{if(document.all){this.doCommand("backcolor",a)}else{this.doCommand("hilitecolor",a)}}setTimeout(Control.RTE.Dialog.closeActive)},insertHtml:function(a){var b=this.getIframeWindow();b.focus();if(document.all){if(this.selectedRange){this.selectedRange.pasteHTML(a);this.selectedRange.collapse(false);this.selectedRange.select()}else{}}else{b.document.execCommand("insertHTML",false,a)}setTimeout(Control.RTE.Dialog.closeActive)},getIframeWindow:function(){return this.iframe.contentWindow},doCommand:function(d,b){clearTimeout(this.syncTimeout);var a=this.getIframeWindow();try{a.focus();a.document.execCommand(d,false,b);a.focus()}catch(c){return false}this.updateToolbarState();this.syncTimeout=setTimeout(this.syncToTextarea.bind(this),1000);return true},debug:function(b){if(!this.debugElement){var a=document.createElement("div");a.style.position="absolute";a.style.top=0;a.style.width="100%";a.style.backgroundColor="#FFFFCC";a.style.MozOpacity=".8";a.style.height="125px";a.style.overflow="auto";a.style.fontFamily="monospace";a.style.borderBottom="1px solid black";this.debugElement=a;document.body.appendChild(this.debugElement);window.onscroll=function(){a.style.top=window.pageYOffset+"px"}}this.debugElement.appendChild(document.createTextNode(b));this.debugElement.appendChild(document.createElement("br"));if(this.debugElement.scrollHeight>125){this.debugElement.scrollTop=this.debugElement.scrollHeight-125}},checkCommand:function(c){var a=this.getIframeWindow();try{return a.document.queryCommandState(c)}catch(b){return false}},checkCommandValue:function(c){var a=this.getIframeWindow();try{return a.document.queryCommandValue(c)}catch(b){return false}},commandEnabled:function(c){var a=this.getIframeWindow();try{return a.document.queryCommandEnabled(c)}catch(b){return false}},getEditorDoc:function(b,c){var a='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">\n';a+="<html>\n";a+="<head>\n";if(c){a+='<link media="all" type="text/css" href="'+c+'" rel="stylesheet">\n'}else{a+='<style type="text/css">\n';a+="body {\n";a+="	background: #FFFFFF;\n";a+="	margin: 2px;\n";a+="	padding: 2px;\n";a+="	font-family: sans-serif;\n";a+="	font-size: 10pt;\n";a+="}\n";a+="</style>\n"}a+='<style type="text/css">\n';a+="body.source {\n";a+="  white-space: pre;\n";a+="  font-family: monospace;\n";a+="  background-color: #FFFFDD;\n";a+="}\n";a+="</style>\n";a+="</head>\n";a+="<body>\n";a+=b+"\n";a+="</body>\n";a+="</html>";return a},toggleSourceView:function(d){var a=this.sourceCheckbox.checked;var c=this.getIframeWindow();var b=c.document;this.syncToTextarea();if(a&&!this.inSourceView){this.inSourceView=true;this.toolbar.disable();if(this.isGecko){b.body.className="source"}this.syncToEditor()}else{if(!a&&this.inSourceView){this.inSourceView=false;if(this.isGecko){b.body.className=""}if(this.isEnabled){this.toolbar.enable()}this.syncToEditor()}}c.focus()},escKeyPressed:function(a){if(a.keyCode==Event.KEY_ESC){Control.RTE.Dialog.destroyActive()}},keyPressHandler:function(b){if(this.isGecko&&b.ctrlKey){var a=String.fromCharCode(b.charCode).toLowerCase();var c=null;switch(a){case"b":c="bold";break;case"i":c="italic";break;case"u":c="underline";break}if(c){this.doCommand(c,false,null);this.updateToolbarState();Event.stop(b)}}},cancelKeyPressHandler:function(a){Event.stop(a)},keyUpHandler:function(a){clearTimeout(this.syncTimeout);if(a.keyCode==Event.KEY_DOWN||a.keyCode==Event.KEY_UP||a.keyCode==Event.KEY_LEFT||a.keyCode==Event.KEY_RIGHT||a.keyCode==Event.KEY_RETURN||a.keyCode==33||a.keyCode==34||a.keyCode==35||a.keyCode==36){this.updateToolbarState()}this.syncTimeout=setTimeout(this.syncToTextarea.bind(this),1000)},markupVariables:function(b){if(this.options.variableClass&&this.options.variableExpression){var a=new RegExp("("+this.options.variableExpression+")","gm");b=b.replace(a,'<span class="'+this.options.variableClass+'">$1</span>')}return b},unmarkupVariables:function(b){if(this.options.variableClass){var a=new RegExp('<span class="'+this.options.variableClass+'">([^<]*)</span>',"gm");b=b.replace(a,"$1")}return b},setText:function(a){this.textarea.value=a;this.syncToEditor()},getText:function(){if(this.isEnabled){this.syncToTextarea()}return this.textarea.value},syncToTextarea:function(){clearTimeout(this.syncTimeout);var a=this.getNodeText(this.getIframeWindow().document.body,!this.inSourceView);a=this.unmarkupVariables(a);this.textarea.value=this.trimWhitespace(this.escapeText(a))},getNodeText:function(b,c){var e;if(!c){if(document.all){e=escape(b.innerText);e=e.replace("%3CP%3E%0D%0A%3CHR%3E","%3CHR%3E");e=unescape(e.replace("%3CHR%3E%0D%0A%3C/P%3E","%3CHR%3E"))}else{var d=b.ownerDocument.createRange();d.selectNodeContents(b);e=d.toString()}if(this.useXHTML){var a=document.createElement("div");a.innerHTML=e;e=get_xhtml(a)}}else{if(this.useXHTML){e=get_xhtml(b)}else{e=b.innerHTML}}return e},escapeText:function(b){for(var a=0;a<b.length;++a){var c=b.charCodeAt(a);if(c==13){b=b.substring(0,a).concat(b.substring(a+1,b.length))}else{if(c>128){if(c==39||c==145||c==146||c==8217||c==8216){b=b.substring(0,a).concat("&apos;",b.substring(a+1,b.length))}else{if(c==34||c==147||c==148||c==8220||c==8221){b=b.substring(0,a).concat("&quot;",b.substring(a+1,b.length))}else{if(c==150||c==8211){b=b.substring(0,a).concat("-",b.substring(a+1,b.length))}else{if(c==153||c==8482){b=b.substring(0,a).concat("&trade;",b.substring(a+1,b.length))}else{b=b.substring(0,a).concat("&#",String(c),";",b.substring(a+1,b.length))}}}}}}}return b},trimWhitespace:function(d){var f=0;var a=-1;for(var b=0;b<d.length;++b){var e=d.charCodeAt(b);switch(d.charCodeAt(b)){case 32:case 8:case 10:case 13:if(a==-1){f=b+1}break;default:a=b}}if(a==-1){return""}return d.substr(f,(a+1)-f)},clearFormatting:function(){var a=document.createElement("div");a.innerHTML=this.getText();this.removeNodeFormatting(a);this.textarea.value=this.getNodeText(a,!this.inSourceView);this.syncToEditor()},removeNodeFormatting:function(b){if(b.childNodes.length>0){for(var a=0;a<b.childNodes.length;++a){var c=b.childNodes[a];if(c.nodeType==1){this.removeNodeFormatting(c);switch(c.nodeName.toLowerCase()){case"p":case"br":case"img":case"a":break;default:a+=c.childNodes.length-1;while(c.firstChild){b.insertBefore(c.firstChild,c)}b.removeChild(c)}}}}},syncToEditor:function(){var a=this.getIframeWindow().document;if(this.inSourceView){if(document.all){a.body.innerText=this.textarea.value}else{var b=a.createTextNode(this.textarea.value);a.body.innerHTML="";a.body.appendChild(b)}}else{a.body.innerHTML=this.markupVariables(this.textarea.value)}}};Control.RTE.Toolbar=Class.create();Object.extend(Control.RTE.Toolbar.prototype,{initialize:function(a,b){this.editor=a;this.items=[];this.element=document.createElement("div");this.element.className="rteToolbar";this.addLayout(b)},add:function(a){a.toolbar=this;this.items.push(a);this.element.appendChild(a.element)},addSeparator:function(){this.add(new Control.RTE.ToolbarSeparator())},addLineBreak:function(){this.add(new Control.RTE.ToolbarLineBreak())},disable:function(){this.disabled=true;Element.addClassName(this.element,"rteToolbarDisabled");this.items.each(function(a){a.disable()})},enable:function(){this.disabled=false;Element.removeClassName(this.element,"rteToolbarDisabled");this.items.each(function(a){a.enable()})},refresh:function(){if(!this.toolbarRefreshing){this.toolbarRefreshing=true;this.items.each(function(a){a.refresh()});if(this.toolbarNeedsRefresh){this.refresh()}this.toolbarRefreshing=false;this.toolbarNeedsRefresh=false}else{this.toolbarNeedsRefresh=true}},addLayout:function(a){if(a=="simple"){this.add(Control.RTE.ToolbarButton.BOLD());this.add(Control.RTE.ToolbarButton.ITALIC());this.add(Control.RTE.ToolbarButton.UNDERLINE());this.add(new Control.RTE.ToolbarSeparator());this.add(Control.RTE.ToolbarButton.UNDO());this.add(Control.RTE.ToolbarButton.REDO())}else{if(a=="html"){this.add(Control.RTE.ToolbarButton.BOLD());this.add(Control.RTE.ToolbarButton.ITALIC());this.add(Control.RTE.ToolbarButton.UNDERLINE());this.add(new Control.RTE.ToolbarSeparator());this.add(Control.RTE.ToolbarButton.UNDO());this.add(Control.RTE.ToolbarButton.REDO());this.add(new Control.RTE.ToolbarSeparator());this.add(Control.RTE.ToolbarButton.TEXT_COLOR());this.add(Control.RTE.ToolbarButton.BACKGROUND_COLOR());this.add(new Control.RTE.ToolbarSeparator());this.add(Control.RTE.ToolbarButton.INSERT_LINK());this.add(Control.RTE.ToolbarButton.INSERT_IMAGE())}else{if(a=="advanced"){this.add(Control.RTE.ToolbarButton.BOLD());this.add(Control.RTE.ToolbarButton.ITALIC());this.add(Control.RTE.ToolbarButton.UNDERLINE());this.add(new Control.RTE.ToolbarSeparator());this.add(Control.RTE.ToolbarButton.LEFT_JUSTIFY());this.add(Control.RTE.ToolbarButton.CENTER_JUSTIFY());this.add(Control.RTE.ToolbarButton.RIGHT_JUSTIFY());this.add(Control.RTE.ToolbarButton.FULL_JUSTIFY());this.add(new Control.RTE.ToolbarSeparator());this.add(Control.RTE.ToolbarButton.UNDO());this.add(Control.RTE.ToolbarButton.REDO());this.add(new Control.RTE.ToolbarSeparator());this.add(Control.RTE.ToolbarButton.HORIZONTAL_RULE());this.add(new Control.RTE.ToolbarSeparator());this.add(Control.RTE.ToolbarButton.ORDERED_LIST());this.add(Control.RTE.ToolbarButton.UNORDERED_LIST());this.add(Control.RTE.ToolbarButton.OUTDENT());this.add(Control.RTE.ToolbarButton.INDENT());this.add(new Control.RTE.ToolbarSeparator());this.add(Control.RTE.ToolbarButton.TEXT_COLOR());this.add(Control.RTE.ToolbarButton.BACKGROUND_COLOR());this.add(new Control.RTE.ToolbarSeparator());this.add(Control.RTE.ToolbarButton.INSERT_LINK());this.add(Control.RTE.ToolbarButton.INSERT_IMAGE());this.add(Control.RTE.ToolbarButton.INSERT_TABLE())}else{this.add(Control.RTE.ToolbarButton.FONT_FACE());this.add(Control.RTE.ToolbarButton.FONT_SIZE());this.add(Control.RTE.ToolbarButton.BLOCK_STYLE());this.add(new Control.RTE.ToolbarLineBreak());this.add(Control.RTE.ToolbarButton.BOLD());this.add(Control.RTE.ToolbarButton.ITALIC());this.add(Control.RTE.ToolbarButton.UNDERLINE());this.add(new Control.RTE.ToolbarSeparator());this.add(Control.RTE.ToolbarButton.LEFT_JUSTIFY());this.add(Control.RTE.ToolbarButton.CENTER_JUSTIFY());this.add(Control.RTE.ToolbarButton.RIGHT_JUSTIFY());this.add(Control.RTE.ToolbarButton.FULL_JUSTIFY());this.add(new Control.RTE.ToolbarSeparator());this.add(Control.RTE.ToolbarButton.UNDO());this.add(Control.RTE.ToolbarButton.REDO());this.add(new Control.RTE.ToolbarSeparator());this.add(Control.RTE.ToolbarButton.HORIZONTAL_RULE());this.add(new Control.RTE.ToolbarSeparator());this.add(Control.RTE.ToolbarButton.ORDERED_LIST());this.add(Control.RTE.ToolbarButton.UNORDERED_LIST());this.add(Control.RTE.ToolbarButton.OUTDENT());this.add(Control.RTE.ToolbarButton.INDENT());this.add(new Control.RTE.ToolbarSeparator());this.add(Control.RTE.ToolbarButton.TEXT_COLOR());this.add(Control.RTE.ToolbarButton.BACKGROUND_COLOR());this.add(new Control.RTE.ToolbarSeparator());this.add(Control.RTE.ToolbarButton.INSERT_LINK());this.add(Control.RTE.ToolbarButton.INSERT_IMAGE());this.add(Control.RTE.ToolbarButton.INSERT_TABLE())}}}}});Control.RTE.ToolbarItem=new Object();Object.extend(Control.RTE.ToolbarItem,{element:null,toolbar:null,refresh:Prototype.emptyFunction,enable:Prototype.emptyFunction,disable:Prototype.emptyFunction});Control.RTE.ToolbarSeparator=Class.create();Object.extend(Control.RTE.ToolbarSeparator.prototype,Control.RTE.ToolbarItem);Object.extend(Control.RTE.ToolbarSeparator.prototype,{initialize:function(){var a=document.createElement("img");a.className="rteVertSep";a.src=Control.RTE.includePath+"separator.gif";a.width=1;a.height=20;this.element=a}});Control.RTE.ToolbarLineBreak=Class.create();Object.extend(Control.RTE.ToolbarLineBreak.prototype,Control.RTE.ToolbarItem);Object.extend(Control.RTE.ToolbarLineBreak.prototype,{initialize:function(){this.element=document.createElement("hr");this.element.className="rteHorizSep"}});Control.RTE.ToolbarButton=Class.create();Object.extend(Control.RTE.ToolbarButton.prototype,Control.RTE.ToolbarItem);Object.extend(Control.RTE.ToolbarButton.prototype,{initialize:function(c,a,b){this.element=this.createButton(c,a,b)},createButton:function(d,b,c){var a=document.createElement("img");a.id=d;a.className="rteButton";a.src=Control.RTE.includePath+b;a.width=25;a.height=24;a.alt=c;a.title=c;this.addCommonBehavior(a);this.addButtonBehavior(a);return a},addButtonBehavior:function(a){this.addButtonActionBehavior(a)},addButtonActionBehavior:function(a,b){a.onclick=function(c){if(!this.toolbar.disabled){(b||Prototype.emptyFunction).bind(this)(c)}}.bindAsEventListener(this);a.onmousedown=function(c){if(!this.toolbar.disabled){Element.addClassName(Event.element(c),"rteButtonActive");Element.removeClassName(Event.element(c),"rteButtonHover")}return false}.bindAsEventListener(this);a.onmouseup=function(c){if(!this.toolbar.disabled){Element.removeClassName(Event.element(c),"rteButtonActive");Element.addClassName(Event.element(c),"rteButtonHover")}}.bindAsEventListener(this);a.onmouseover=function(c){if(!this.toolbar.disabled&&!Element.hasClassName(Event.element(c),"rteButtonActive")){Element.addClassName(Event.element(c),"rteButtonHover")}}.bindAsEventListener(this);a.onmouseout=function(c){if(!this.toolbar.disabled){Element.removeClassName(Event.element(c),"rteButtonHover")}Element.removeClassName(Event.element(c),"rteButtonActive")}.bindAsEventListener(this)},addCommonBehavior:function(a){a.onmousedown=function(){return false};a.onselectstart=function(){return false}},disable:function(){Element.setOpacity(this.element,0.3)},enable:function(){Element.setOpacity(this.element,1)}});Control.RTE.ToolbarCommandButton=Class.create();Object.extend(Control.RTE.ToolbarCommandButton.prototype,Control.RTE.ToolbarButton.prototype);Object.extend(Control.RTE.ToolbarCommandButton.prototype,{initialize:function(e,b,d,c,a){this.command=c;this.noSync=a;this.element=this.createButton(e,b,d)},addButtonBehavior:function(a){if(this.noSync){this.addButtonActionBehavior(a,function(b){return this.toolbar.editor.doCommand(this.command)}.bindAsEventListener(this))}else{this.addButtonStateBehavior(a,function(b){return this.toolbar.editor.doCommand(this.command)}.bindAsEventListener(this))}},addButtonStateBehavior:function(a,b){a.onmousedown=function(c){if(!this.toolbar.disabled&&b(c)){if(this.toolbar.editor.checkCommand(this.command)){Element.addClassName(Event.element(c),"rteButtonActive");Element.removeClassName(Event.element(c),"rteButtonHover")}else{Element.removeClassName(Event.element(c),"rteButtonActive");Element.addClassName(Event.element(c),"rteButtonHover")}}return false}.bindAsEventListener(this);a.onmouseover=function(c){if(!this.toolbar.disabled&&!Element.hasClassName(Event.element(c),"rteButtonActive")){Element.addClassName(Event.element(c),"rteButtonHover")}}.bindAsEventListener(this);a.onmouseout=function(c){if(!this.toolbar.disabled){Element.removeClassName(Event.element(c),"rteButtonHover")}}.bindAsEventListener(this)},refresh:function(){if(this.toolbar.editor.checkCommand(this.command)){Element.addClassName(this.element,"rteButtonActive")}else{Element.removeClassName(this.element,"rteButtonActive")}}});Control.RTE.ToolbarDialogButton=Class.create();Object.extend(Control.RTE.ToolbarDialogButton.prototype,Control.RTE.ToolbarButton.prototype);Object.extend(Control.RTE.ToolbarDialogButton.prototype,{initialize:function(d,a,c,b){this.dialogType=b;this.element=this.createButton(d,a,c)},addButtonBehavior:function(a){this.addButtonActionBehavior(a,function(b){return this.toolbar.editor.showDialog(this.dialogType,b)}.bindAsEventListener(this))}});Control.RTE.ToolbarCommandList=Class.create();Object.extend(Control.RTE.ToolbarCommandList.prototype,Control.RTE.ToolbarItem);Object.extend(Control.RTE.ToolbarCommandList.prototype,{initialize:function(d,a,c,b){this.command=b;this.element=this.createList(d,a,c)},createList:function(d,b,c){var a=new Element("select",{id:d});a.appendChild(new Element("option",{value:""}).insert({top:c}));if(b.constructor==Array){b.each(function(e){a.appendChild(new Element("option",{value:e}).insert({top:e}))})}else{$H(b).each(function(e){a.appendChild(new Element("option",{value:e[0]}).insert({top:e[1]}))})}this.applyBehavior(a);return a},applyBehavior:function(a){a.onchange=this.valueChanged.bindAsEventListener(this)},valueChanged:function(c){if(!this.toolbar.disabled){var a=Event.element(c);var b=a.options[a.selectedIndex].value;this.toolbar.editor.doCommand(this.command,b)}},refresh:function(){var b=this.toolbar.editor.checkCommandValue(this.command);for(var a=0;a<this.element.options.length;++a){if(this.element.options[a].value==b){this.element.selectedIndex=a}break}},disable:function(){this.element.disabled=true},enable:function(){this.element.disabled=false}});Control.RTE.ToolbarVariableList=Class.create();Object.extend(Control.RTE.ToolbarVariableList.prototype,Control.RTE.ToolbarItem);Object.extend(Control.RTE.ToolbarVariableList.prototype,{initialize:function(d,b,c,a){this.spanClass=a;this.element=this.createList(d,b,c)},createList:function(d,b,c){var a=new Element("select",{id:d});a.appendChild(new Element("option",{value:""}).insert({top:c}));b.each(function(e){a.appendChild(new Element("option",{value:e}).insert({top:e}))});this.applyBehavior(a);return a},applyBehavior:function(a){a.onchange=this.valueChanged.bindAsEventListener(this)},valueChanged:function(c){if(!this.toolbar.disabled){var a=Event.element(c);var b=a.options[a.selectedIndex].value;if(b){if(this.spanClass){b='<span class="'+this.spanClass+'">'+b+"</span>&nbsp;"}this.toolbar.editor.insertHtml(b)}a.selectedIndex=0}},disable:function(){this.element.disabled=true},enable:function(){this.element.disabled=false}});Control.RTE.ToolbarButton.FONT_FACE=function(){return new Control.RTE.ToolbarCommandList("rteFontFace",{serif:"Serif","sans-serif":"Sans Serif",monospace:"Monospace"},"Font","fontname")};Control.RTE.ToolbarButton.FONT_SIZE=function(){return new Control.RTE.ToolbarCommandList("rteFontSize",{"1":"-1","2":"Normal","3":"+1","4":"+2","5":"+3","6":"+4","7":"+5"},"Font Size","fontsize")};Control.RTE.ToolbarButton.BLOCK_STYLE=function(){return new Control.RTE.ToolbarCommandList("rteBlockStyle",{span:"No Style",p:"Paragraph",pre:"Preformatted",h1:"Heading 1",h2:"Heading 2",h3:"Heading 3",h4:"Heading 4",h5:"Heading 5",h6:"Heading 6",address:"Address"},"Style","formatblock")};Control.RTE.ToolbarButton.BOLD=function(){return new Control.RTE.ToolbarCommandButton("rteBold","bold.gif","Bold","bold")};Control.RTE.ToolbarButton.ITALIC=function(){return new Control.RTE.ToolbarCommandButton("rteItalic","italic.gif","Italic","italic")};Control.RTE.ToolbarButton.UNDERLINE=function(){return new Control.RTE.ToolbarCommandButton("rteUnderline","underline.gif","Underline","underline")};Control.RTE.ToolbarButton.LEFT_JUSTIFY=function(){return new Control.RTE.ToolbarCommandButton("rteLeftJustify","left_just.gif","Align Left","justifyleft")};Control.RTE.ToolbarButton.CENTER_JUSTIFY=function(){return new Control.RTE.ToolbarCommandButton("rteCenterJustify","centre.gif","Align Center","justifycenter")};Control.RTE.ToolbarButton.RIGHT_JUSTIFY=function(){return new Control.RTE.ToolbarCommandButton("rteRightJustify","right_just.gif","Align Right","justifyright")};Control.RTE.ToolbarButton.FULL_JUSTIFY=function(){return new Control.RTE.ToolbarCommandButton("rteFullJustify","justifyfull.gif","Full Justified","justifyfull")};Control.RTE.ToolbarButton.UNDO=function(){return new Control.RTE.ToolbarCommandButton("rteUndo","undo.gif","Undo","undo",true)};Control.RTE.ToolbarButton.REDO=function(){return new Control.RTE.ToolbarCommandButton("rteRedo","redo.gif","Redo","redo",true)};Control.RTE.ToolbarButton.HORIZONTAL_RULE=function(){return new Control.RTE.ToolbarCommandButton("rteHorizontalRule","hr.gif","Horizontal Rule","inserthorizontalrule",true)};Control.RTE.ToolbarButton.ORDERED_LIST=function(){return new Control.RTE.ToolbarCommandButton("rteOrderedList","numbered_list.gif","Ordered List","insertorderedlist")};Control.RTE.ToolbarButton.UNORDERED_LIST=function(){return new Control.RTE.ToolbarCommandButton("rteUnorderedList","list.gif","Unordered List","insertunorderedlist")};Control.RTE.ToolbarButton.OUTDENT=function(){return new Control.RTE.ToolbarCommandButton("rteOutdent","outdent.gif","Outdent","outdent",true)};Control.RTE.ToolbarButton.INDENT=function(){return new Control.RTE.ToolbarCommandButton("rteIndent","indent.gif","Indent","indent",true)};Control.RTE.ToolbarButton.TEXT_COLOR=function(){return new Control.RTE.ToolbarDialogButton("rteTextColor","textcolor.gif","Text Color","textcolor")};Control.RTE.ToolbarButton.BACKGROUND_COLOR=function(){return new Control.RTE.ToolbarDialogButton("rteBackgroundColor","bgcolor.gif","Background Color","bgcolor")};Control.RTE.ToolbarButton.INSERT_LINK=function(){return new Control.RTE.ToolbarDialogButton("rteLink","hyperlink.gif","Insert Link","link")};Control.RTE.ToolbarButton.INSERT_IMAGE=function(){return new Control.RTE.ToolbarDialogButton("rteImage","image.gif","Insert Image","image")};Control.RTE.ToolbarButton.INSERT_TABLE=function(){return new Control.RTE.ToolbarDialogButton("rteTable","insert_table.gif","Insert Table","table")};Control.RTE.Dialog=Class.create();Object.extend(Control.RTE.Dialog,{activeEffect:null,activeDialog:null,closeActive:function(){if(Control.RTE.Dialog.activeDialog){if(Control.RTE.useEffects){if(Control.RTE.Dialog.activeEffect){Control.RTE.Dialog.activeEffect.cancel()}Control.RTE.Dialog.activeEffect=new Effect.SlideUp(Control.RTE.Dialog.activeDialog.dialogContainer,{afterFinish:Control.RTE.Dialog.destroyActive,duration:0.2})}else{Control.RTE.Dialog.destroyActive()}}},destroyActive:function(){if(Control.RTE.Dialog.activeDialog){if(Control.RTE.Dialog.activeEffect){Control.RTE.Dialog.activeEffect.cancel();Control.RTE.Dialog.activeEffect=null}Control.RTE.Dialog.activeDialog.destroy();Control.RTE.Dialog.activeDialog=null}},activate:function(c,d,b,a,e){Control.RTE.Dialog.destroyActive();Control.RTE.Dialog.activeDialog=Control.RTE.Dialog.cache[c];Control.RTE.Dialog.cache[c].activate(d,b,a,e)}});Object.extend(Control.RTE.Dialog.prototype,{initialize:function(){var a=Control.RTE.createElement("div",null,null,{position:"absolute"});var b=Control.RTE.createElement("div",null,"rteDialog");b.appendChild(this.create());a.appendChild(b);Element.hide(a);this.element=a},activate:function(f,e,i,h){this.editor=f;this.callback=h;this.editor.editorDiv.appendChild(this.element);if(e){var a=Position.cumulativeOffset(e);this.element.style.top=(a[1]+e.offsetHeight)+"px";var g=Position.cumulativeOffset(f.editorDiv)[0]+f.editorDiv.offsetWidth;var c=a[0];var b=Element.getDimensions(this.element).width;if(c+b>g){c=g-b}this.element.style.left=c+"px"}else{this.element.style.top=Position.cumulativeOffset(f.iframeDiv)[1]+"px";var b=Element.getDimensions(this.element).width;var d=f.editorDiv.offsetWidth;var c=((d-b)/2)+Position.cumulativeOffset(f.editorDiv)[0];this.element.style.left=c+"px"}this.refresh(i);if(Control.RTE.useEffects){Control.RTE.Dialog.activeEffect=new Effect.SlideDown(this.element,{afterFinish:this.dialogReady.bind(this),duration:0.2})}else{Element.show(this.element);this.dialogReady()}},refresh:function(a){},destroy:function(){Element.remove(this.element);if(this.editor){this.editor.activeDialog=null}this.editor=null;this.callback=null},dialogReady:function(a){if(Control.RTE.Dialog.activeEffect==a){Control.RTE.Dialog.activeEffect=null}if(Control.RTE.Dialog.activeDialog==this){(this.focus||Prototype.emptyFunction).bind(this)();(this.callback||Prototype.emptyFunction)();this.editor.getIframeWindow().blur();window.focus()}},create:function(){return document.createElement("div")}});Control.RTE.Dialog.ColorPalette=Class.create();Object.extend(Control.RTE.Dialog.ColorPalette.prototype,Control.RTE.Dialog.prototype);Object.extend(Control.RTE.Dialog.ColorPalette.prototype,{create:function(){this.colorpicker=new Control.ColorPicker.Panel({className:"rteColorPicker",onSelect:function(a){this.editor.setDialogColor(a)}.bind(this)});return this.colorpicker.element},focus:function(){Field.activate(this.colorpicker.customInput)}});Control.RTE.Dialog.InsertLink=Class.create();Object.extend(Control.RTE.Dialog.InsertLink.prototype,Control.RTE.Dialog.prototype);Object.extend(Control.RTE.Dialog.InsertLink.prototype,{create:function(){var i=document.createElement("div");var a=Control.RTE.createElement("table",{cellpadding:2,cellspacing:0,border:0});var g=a.insertRow(0);var f=g.insertCell(0);f.innerHTML="Title";f=g.insertCell(1);var h=Control.RTE.createElement("input",{id:"link_title",type:"text"},null,{width:"120px",border:"1px solid gray"});f.appendChild(h);var g=a.insertRow(1);var f=g.insertCell(0);f.innerHTML="URL";f=g.insertCell(1);var c=Control.RTE.createElement("input",{id:"link_url",type:"text"},null,{width:"120px",border:"1px solid gray"});f.appendChild(c);var g=a.insertRow(2);var f=g.insertCell(0);f.innerHTML="Tooltip";f=g.insertCell(1);f.appendChild(Control.RTE.createElement("input",{id:"link_tooltip",type:"text"},null,{width:"120px",border:"1px solid gray"}));var g=a.insertRow(3);var f=g.insertCell(0);f.innerHTML="&nbsp;";f=g.insertCell(1);f.appendChild(Control.RTE.createElement("input",{id:"link_newwindow",type:"checkbox"}));var e=Control.RTE.createElement("label",{"for":"link_newwindow"});e.innerHTML="New window";f.appendChild(e);var g=a.insertRow(4);var f=g.insertCell(0);f.colSpan=2;f.align="center";f.appendChild(Control.RTE.createElement("hr",null,"rteHorizSep"));var d=Control.RTE.createElement("input",{id:"link_insert",type:"submit",value:"Insert Link"},null,{border:"1px solid gray"});f.appendChild(d);var b=Control.RTE.createElement("form",{id:"link_form"},null,{margin:"0",padding:"0"});b.onsubmit=this.submitLinkListener();b.appendChild(a);i.appendChild(b);return i},focus:function(){var a=this.editor.getSelectedText();if(a&&a!=""){$("link_title").value=a;Field.activate("link_url")}else{Field.activate("link_title")}},submitLinkListener:function(){return function(a){var b='<a href="'+$("link_url").value+'"';if($("link_newwindow").checked){b+=' target="_new"'}if($("link_tooltip").value!=""){b+=' title="'+$("link_tooltip").value+'"'}b+=">"+$("link_title").value+"</a>";this.editor.insertHtml(b);return false}.bindAsEventListener(this)}});Control.RTE.Dialog.InsertTable=Class.create();Object.extend(Control.RTE.Dialog.InsertTable.prototype,Control.RTE.Dialog.prototype);Object.extend(Control.RTE.Dialog.InsertTable.prototype,{create:function(){var c=document.createElement("div");var d=Control.RTE.createElement("table",{cellpadding:2,cellspacing:0,border:0});var h=d.insertRow(0);var b=h.insertCell(0);b.innerHTML="Rows";b=h.insertCell(1);b.appendChild(Control.RTE.createElement("input",{id:"table_rows",type:"text",value:"2",align:"right"},null,{width:"30px",border:"1px solid gray",paddingRight:"3px"}));var b=h.insertCell(2);b.width=5;b.innerHTML="&nbsp;";var b=h.insertCell(3);b.innerHTML="Columns";b=h.insertCell(4);b.appendChild(Control.RTE.createElement("input",{id:"table_cols",type:"text",value:"2",align:"right"},null,{width:"30px",border:"1px solid gray",paddingRight:"3px"}));h=d.insertRow(1);b=h.insertCell(0);b.innerHTML="Width";b=h.insertCell(1);b.colSpan=4;b.appendChild(Control.RTE.createElement("input",{id:"table_width",type:"text",value:"100",align:"right"},null,{width:"30px",border:"1px solid gray",paddingRight:"3px"}));var a=Control.RTE.createElement("select",{id:"table_width_type"},null,{border:"1px solid gray",marginLeft:"3px"});var f=Control.RTE.createElement("option",{value:"px"});f.innerHTML="pixels";a.appendChild(f);f=Control.RTE.createElement("option",{value:"%"});f.innerHTML="percent";f.selected=true;a.appendChild(f);b.appendChild(a);h=d.insertRow(2);b=h.insertCell(0);b.colSpan=5;b.appendChild(Control.RTE.createElement("hr",null,"rteHorizSep"));h=d.insertRow(3);b=h.insertCell(0);b.colSpan=3;b.innerHTML="Border width";b=h.insertCell(1);b.colSpan=2;b.appendChild(Control.RTE.createElement("input",{id:"table_border",type:"text",value:"1",align:"right"},null,{width:"30px",border:"1px solid gray",paddingRight:"3px"}));h=d.insertRow(4);b=h.insertCell(0);b.colSpan=3;b.innerHTML="Cell spacing";b=h.insertCell(1);b.colSpan=2;b.appendChild(Control.RTE.createElement("input",{id:"table_cellspacing",type:"text",value:"1",align:"right"},null,{width:"30px",border:"1px solid gray",paddingRight:"3px"}));h=d.insertRow(5);b=h.insertCell(0);b.colSpan=3;b.innerHTML="Cell padding";b=h.insertCell(1);b.colSpan=2;b.appendChild(Control.RTE.createElement("input",{id:"table_cellpadding",type:"text",value:"1",align:"right"},null,{width:"30px",border:"1px solid gray",paddingRight:"3px"}));h=d.insertRow(6);b=h.insertCell(0);b.colSpan=5;b.align="center";b.appendChild(Control.RTE.createElement("hr",null,"rteHorizSep"));var g=Control.RTE.createElement("input",{id:"table_insert",type:"submit",value:"Insert Table"},null,{border:"1px solid gray"});b.appendChild(g);var e=Control.RTE.createElement("form",{id:"table_form"},null,{margin:"0",padding:"0"});e.onsubmit=this.submitTableListener();e.appendChild(d);c.appendChild(e);return c},submitTableListener:function(){return function(h){var b='<table border="'+$("table_border").value+'"';b+=' cellspacing="'+$("table_cellspacing").value+'"';b+=' cellpadding="'+$("table_cellpadding").value+'"';var d=$("table_width").value+$("table_width_type").options[$("table_width_type").selectedIndex].value;b+=' width="'+d+'">';var f=parseInt($("table_rows").value);var g=parseInt($("table_cols").value);for(var c=0;c<f;++c){b+="<tr>";for(var a=0;a<f;++a){b+="<td>&nbsp;</td>"}b+="</tr>"}b+="</table>";this.editor.insertHtml(b);return false}.bindAsEventListener(this)},focus:function(){$("table_rows").focus();$("table_rows").select()}});Control.RTE.Dialog.ImageBrowser=Class.create();Object.extend(Control.RTE.Dialog.ImageBrowser.prototype,Control.RTE.Dialog.prototype);Object.extend(Control.RTE.Dialog.ImageBrowser.prototype,{create:function(){var a=document.createElement("div");this.imageForm=this.createAttributeForm();a.appendChild(this.imageForm);return a},refresh:function(a){this.imageForm.reset();if(a&&a.fileLister&&typeof Control.FileChooser!="undefined"){if(!this.browser){this.browser=new Control.FileChooser.Panel(null,{className:"rteFileChooser",fileImage:Control.RTE.includePath+"/file.gif",directoryImage:Control.RTE.includePath+"/directory.gif",parentImage:Control.RTE.includePath+"/parent.gif",selectListener:function(b){$("image_url").value=b},previewListener:function(c,b){$("image_width").value=c;$("image_height").value=b},openListener:this.submitImageListener()});this.imageForm.parentNode.insertBefore(this.browser.getElement(),this.imageForm)}this.browser.fileLister=a.fileLister;this.browser.refresh(null)}},createAttributeForm:function(){var g=Control.RTE.createElement("form",{id:"image_form"},null,{margin:"0",padding:"0"});g.onsubmit=this.submitImageListener();var c=Control.RTE.createElement("table",{cellpadding:2,cellspacing:0,border:0});var f=c.insertRow(0);var b=f.insertCell(0);b.innerHTML="<nobr>Image URL</nobr>";b=f.insertCell(1);b.colSpan=7;b.appendChild(Control.RTE.createElement("input",{id:"image_url",type:"text"},null,{width:"295px",border:"1px solid gray"}));f=c.insertRow(1);b=f.insertCell(0);b.innerHTML="Width";b=f.insertCell(1);b.appendChild(Control.RTE.createElement("input",{id:"image_width",type:"text",align:"right"},null,{width:"30px",border:"1px solid gray",paddingRight:"3px"}));b=f.insertCell(2);b.width=5;b.innerHTML="&nbsp;";b=f.insertCell(3);b.innerHTML="Height";b=f.insertCell(4);b.align="right";b.appendChild(Control.RTE.createElement("input",{id:"image_height",type:"text",align:"right"},null,{width:"30px",border:"1px solid gray",paddingRight:"3px"}));b=f.insertCell(5);b.width=5;b.innerHTML="&nbsp;";b=f.insertCell(6);b.innerHTML="Alignment";b=f.insertCell(7);var a=Control.RTE.createElement("select",{id:"image_align"},null,{border:"1px solid gray"});var d=Control.RTE.createElement("option",{value:""});d.innerHTML="Default";d.selected=true;a.appendChild(d);d=Control.RTE.createElement("option",{value:"left"});d.innerHTML="Left";a.appendChild(d);d=Control.RTE.createElement("option",{value:"center"});d.innerHTML="Center";a.appendChild(d);d=Control.RTE.createElement("option",{value:"right"});d.innerHTML="Right";a.appendChild(d);b.appendChild(a);g.appendChild(c);c=Control.RTE.createElement("table",{cellpadding:2,cellspacing:0,border:0});f=c.insertRow(0);b=f.insertCell(0);b.innerHTML="Description";b=f.insertCell(1);b.appendChild(Control.RTE.createElement("input",{id:"image_title",type:"text"},null,{width:"295px",border:"1px solid gray"}));f=c.insertRow(1);b=f.insertCell(0);b.innerHTML="Alt text";b=f.insertCell(1);b.appendChild(Control.RTE.createElement("input",{id:"image_alt",type:"text"},null,{width:"295px",border:"1px solid gray"}));f=c.insertRow(2);b=f.insertCell(0);b.colSpan=2;b.appendChild(Control.RTE.createElement("hr",null,"rteHorizSep"));g.appendChild(c);var e=Control.RTE.createElement("div",null,null,{textAlign:"center"});e.appendChild(Control.RTE.createElement("input",{id:"image_insert",type:"submit",value:"Insert Image"},null,{border:"1px solid gray"}));g.appendChild(e);return g},createImageHtml:function(b,c,a,g,f,e){var d='<img src="'+b+'"';if(c&&c!=""){d+=' width="'+c+'"'}if(a&&a!=""){d+=' height="'+a+'"'}if(g&&g!=""){d+=' align="'+g+'"'}if(f&&f!=""){d+=' title="'+f+'"'}if(e&&e!=""){d+=' alt="'+e+'"'}d+=' border="0"/>';return d},submitImageListener:function(){return function(f){var b=$("image_url").value;var c=$("image_width").value;var a=$("image_height").value;var h=$("image_align").options[$("image_align").selectedIndex].value;var g=$("image_title").value;var d=$("image_alt").value;this.editor.insertHtml(this.createImageHtml(b,c,a,h,g,d));return false}.bindAsEventListener(this)}});Protoplasm.register("rte",Control.RTE);if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize tabstrip")}if(window.Control==undefined){Control={}}Protoplasm.loadStylesheet("tabstrip.css","tabstrip");Control.TabStrip=Class.create({initialize:function(b,a){b=$(b);if(ts=b.retrieve("tabstrip")){ts.destroy()}b.addClassName("_pp_tabstrip");a=Object.extend({activeClass:"active",disabledClass:"disabled",onClick:Prototype.emptyFunction,disabled:false},a||{});this.element=b;this.options=a;this.tabs=[];this.panels=[];this.active=-1;this.disabled=[];this.listeners=[Event.on(window,"unload",this.destroy.bind(this))];this.createTabs(b,a);if(a.activeTab){this.switchTab(a.activeTab)}b.store("tabstrip",this)},createTabs:function(p){if(p.childElements().length==2){var f=p.childElements()[0];f.cleanWhitespace();f.addClassName("_pp_tabstrip_tabs");var k=f.childElements();var c=f.wrap("div",{"class":"_pp_tabstrip_scroller"});this.scroller=c;var j=p.childElements()[1];j.addClassName("_pp_tabstrip_panels");var g=j.childElements();var h=this.options.disabled;var n=this.options.disabledClass;if(k.length==g.length){for(var b=0;b<k.length;b++){var o=this;this.listeners.push(k[b].on("click",function(d){return function(i){if(!d.id||!this.disabled.include(d.id)){this.switchTab(d)}}.bindAsEventListener(o)}(k[b])));this.listeners.push(k[b].on("mousedown",function(d){Event.stop(d);return false}.bindAsEventListener(this)));this.listeners.push(k[b].on("selectstart",function(d){Event.stop(d);return false}.bindAsEventListener(this)));if((h&&h.include(k[b].id))||(n&&k[b].hasClassName(n))){this.disable(k[b])}}g.invoke("hide");this.tabs=k;this.panels=g;var m=this.tabs[this.tabs.length-1].getLayout();var l=m.get("left")+m.get("width");if(l>c.getLayout().get("width")){var e=new Element("div",{"class":"_pp_tabstrip_scroll"});var a=new Element("div",{"class":"_pp_tabstrip_scroll_left"});var l=new Element("div",{"class":"_pp_tabstrip_scroll_right"});this.makeScroller(a,f,c,20);this.makeScroller(l,f,c,-20);e.insert(a);e.insert(l);c.insert(e)}this.switchTabByIndex(0)}}},makeScroller:function(c,d,b,a){var e=false;c.on("mousedown",function(h){e=true;var g;setTimeout(function(){if(e){g=setInterval(function(){if(e){var i=d.getLayout();this.scrollTo(d,b,i.get("left")+a)}else{clearInterval(g)}}.bind(this),50)}}.bind(this),500);var f=d.getLayout();this.scrollTo(d,b,f.get("left")+a)}.bindAsEventListener(this));c.on("mouseup",function(f){e=false}.bindAsEventListener(this));c.on("mouseout",function(f){e=false}.bindAsEventListener(this));c.on("selectstart",function(f){Event.stop(f)}.bindAsEventListener(this))},scrollTo:function(g,a,c){var i=g.childNodes[g.childNodes.length-1];var e=i.getLayout();var b=e.get("left")+e.get("margin-box-width");var d=a.getLayout();var h=0;var f=-(b-d.get("width")+29+3);if(c<f){c=f}else{if(c>h){c=h}}g.style.left=c+"px"},scrollVisible:function(b){var g=this.scroller.firstChild;var e=b.getLayout();var d=g.getLayout();var a=this.scroller.getLayout();var c=-d.get("left");var i=c+(a.get("width")-29);var f=-c;if(e.get("left")<c){f=-(e.get("left")-6)}else{if(e.get("left")+e.get("margin-box-width")>i){var h=e.get("left")+e.get("margin-box-width");f=-c-(h-i)-9}}if(f!=-c){this.scrollTo(g,this.scroller,f)}},enable:function(a){var a=$(a);if(a){a.removeClassName(this.options.disabledClass);this.disabled=this.disabled.without(a.id)}},disable:function(a){var a=$(a);if(a){a.addClassName(this.options.disabledClass);if(!this.disabled.include(a.id)){this.disabled.push(a.id)}}},destroy:function(){this.switchTabByIndex(0);this.listeners.invoke("stop");this.element.select("._pp_tabstrip_tabs").invoke("removeClassName","_pp_tabstrip_tabs");this.element.select("._pp_tabstrip_panels").invoke("removeClassName","_pp_tabstrip_panels");this.element.removeClassName("_pp_tabstrip");this.scroller.parentNode.replaceChild(this.scroller.firstChild,this.scroller);this.element.store("tabstrip",null)},switchTab:function(b){b=$(b);for(var a=0;a<this.tabs.length;++a){if(this.tabs[a]==b){return this.switchTabByIndex(a)}}},switchTabByIndex:function(a){var b=this.tabs[a];if(this.active!=a){if(this.active>-1){this.tabs[this.active].removeClassName(this.options.activeClass);this.panels[this.active].hide()}Element.addClassName(b,this.options.activeClass);this.scrollVisible(b);this.panels[a].show();this.active=a;if(this.options.onClick){this.options.onClick(b)}}}});Protoplasm.register("tabstrip",Control.TabStrip);if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize ticker")}if(typeof Control=="undefined"){Control={}}Control.TickerBase=Class.create({initialize:function(b,c,a){this.options=Object.extend({interval:10,step:1},a||{});this.element=$(b);this.generator=c;this.element.style.overflow="hidden";this.scroller=new Element("div");this.element.appendChild(this.scroller);this.active=0;this.offset=0;this.start()},start:function(){this.timer=setInterval(function(){this.scroll(this.options.step)}.bind(this),this.options.interval)},scroll:function(d){var a=this.generator();var c=scroller.firstChild;var b=scroller.childNodes[scroller.childNodes.length-1]},stop:function(){if(this.timer){clearInterval(this.timer);this.timer=null}}});Control.Ticker=Class.create(Control.TickerBase,{initialize:function($super,c,b){var a=$(c).childElements();a.invoke("hide");$super(c,function(){return a.invoke("clone",true)},b)}});Protoplasm.register("ticker",Control.Ticker);if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize timepicker")}if(typeof Control=="undefined"){Control={}}Protoplasm.loadStylesheet("timepicker.css","timepicker");Control.TimePicker=Class.create({initialize:function(b,a){b=$(b);if(tp=b.retrieve("timepicker")){tp.destroy()}var c=b.wrap("span",{style:"position:relative;"});a=Object.extend({format:"HH:mm:ss"},a||{});if(!a.icon){a.icon=Protoplasm.base("timepicker")+"clock.png"}this.element=b;this.label=b;this.wrapper=c;this.options=a;this.changeHandler=a.onChange;this.selectHandler=a.onSelect;a.onSelect=this.onSelect.bind(this);a.onChange=this.onChange.bind(this);this.panel=null;this.dialog=null;this.listeners=[b.on("click",this.toggle.bindAsEventListener(this)),b.on("keydown",this.keyHandler.bindAsEventListener(this)),Event.on(window,"unload",this.destroy.bind(this))];if(a.icon){b.style.background="url("+a.icon+") right center no-repeat #FFF";this.oldPadding=b.style.paddingRight;b.style.paddingRight="20px"}this.hideListener=null;this.keyListener=null;this.active=false;this.element.store("timepicker",this);this.element=Protoplasm.extend(b,{show:c.show.bind(c),hide:c.hide.bind(c),open:this.open.bind(this),toggle:this.toggle.bind(this),close:this.close.bind(this),destroy:this.destroy.bind(this)})},destroy:function(){Protoplasm.revert(this.element);this.listeners.invoke("stop");if(this.hideListener){this.hideListener.stop()}if(this.keyListener){this.keyListener.stop()}this.wrapper.parentNode.replaceChild(this.element,this.wrapper);this.element.style.paddingRight=this.oldPadding;this.element.store("timepicker",null)},clickHandler:function(b){var a=Event.element(b);do{if(a==this.element||a==this.label||a==this.dialog){return}}while(a=a.parentNode);this.close()},setValue:function(g){var f=g.getHours();var b=g.getMinutes();var e=g.getSeconds();var c="";if(!this.options.use24hrs){c=" AM";if(f==0){f=12}else{if(f>11){if(f>12){f-=12}c=" PM"}}}f=f<10?"0"+f:f;b=b<10?"0"+b:b;e=e<10?"0"+e:e;this.element.value=f+":"+b+":"+e+c},onSelect:function(a){this.setValue(a);this.close();if(this.selectHandler){this.selectHandler(a)}},onChange:function(a){this.setValue(a);if(this.changeHandler){this.changeHandler(a)}},toggle:function(a){if(this.active){this.close()}else{setTimeout(this.open.bind(this))}},keyHandler:function(a){switch(a.keyCode){case Event.KEY_ESC:this.close();return;case Event.KEY_RETURN:this.close();return;case Event.KEY_TAB:this.close();return;case Event.KEY_DOWN:if(!this.dialog||!this.dialog.parentNode){this.open();Event.stop(a)}}if(this.pickerActive){return false}},docKeyHandler:function(a){switch(a.keyCode){case Event.KEY_ESC:this.close();return;case Event.KEY_RETURN:this.close();Event.stop(a);return}if(this.pickerActive){return false}},open:function(){if(!this.active){if(!this.dialog){this.panel=new Control.TimePicker.Panel(this.options);this.dialog=new Element("div",{"class":"_pp_frame_small",style:"position:absolute;"});this.dialog.insert(this.panel.element)}var b=this.label.getLayout();var a=b.get("border-box-height")-b.get("border-bottom");document.body.appendChild(this.dialog);this.dialog.clonePosition(this.label,{setWidth:false,setHeight:false,offsetTop:a,offsetLeft:-3});this.dialog.style.zIndex="99";this.panel.setTime(this.parse(this.element.value));this.panel.hours.focus();this.hideListener=document.on("click",this.clickHandler.bindAsEventListener(this));this.keyListener=document.on("keydown",this.docKeyHandler.bindAsEventListener(this));this.active=true}},parse:function(g){var f,e,a,c,b;if(!this.options.use24hrs){f=g.split(/ /);if(f.length>1){b=f[1].toUpperCase()}g=f[0]}f=g.split(":");e=f[0]||0;a=f[1]||0;c=f.length>2?f[2]:0;if(!this.options.use24hrs){if(b=="AM"&&e==12){e=0}else{if(e<12&&b=="PM"){e+=12}}}d=new Date();d.setHours(e);d.setMinutes(a);d.setSeconds(c);return d},close:function(){if(this.active){this.dialog.remove();this.active=false;if(this.hideListener){this.hideListener.stop()}if(this.keyListener){this.keyListener.stop()}}}});Control.TimePicker.Panel=Class.create({initialize:function(a){this.options=Object.extend({},a||{});this.time=this.options.time||new Date();this.ampm="AM";this.element=this.createPicker();this.element.on("selectstart",function(b){Event.stop(b)}.bindAsEventListener(this))},createPicker:function(){var a=new Element("div",{"class":"_pp_timepicker "+this.options.className});this.hours=new Element("input",{type:"text","class":"_pp_timepicker_input",value:"00"});this.minutes=new Element("input",{type:"text","class":"_pp_timepicker_input",value:"00"});this.seconds=new Element("input",{type:"text","class":"_pp_timepicker_input",value:"00"});var b=new Element("table",{cellPadding:0,cellSpacing:0,border:0});var c=b.insertRow(0);c.appendChild(this.createCell(this.hours,this.options.use24hrs?23:12,this.options.use24hrs?0:1));c.appendChild(new Element("td").update(":"));c.appendChild(this.createCell(this.minutes,59,0));c.appendChild(new Element("td").update(":"));c.appendChild(this.createCell(this.seconds,59,0));if(!this.options.use24hrs){var e=new Element("td");this.am=new Element("div",{"class":"_pp_timepicker_ampm _pp_highlight"}).update("AM");this.am.on("click",function(){this.ampm="AM";this.pm.removeClassName("_pp_highlight");this.am.addClassName("_pp_highlight");this.onChange()}.bindAsEventListener(this));this.pm=new Element("div",{"class":"_pp_timepicker_ampm"}).update("PM");this.pm.on("click",function(){this.ampm="PM";this.am.removeClassName("_pp_highlight");this.pm.addClassName("_pp_highlight");this.onChange()}.bindAsEventListener(this));e.appendChild(this.am);e.appendChild(this.pm);c.appendChild(e)}a.appendChild(b);return a},createCell:function(b,e,c){var g=new Element("td");b.on("keydown",function(h){if(h.keyCode==Event.KEY_UP){this.increment(b,e,c);this.onChange();Event.stop(h)}else{if(h.keyCode==Event.KEY_DOWN){this.decrement(b,e,c);this.onChange();Event.stop(h)}else{if(h.keyCode==Event.KEY_RETURN){this.onSelect();Event.stop(h);return false}}}}.bindAsEventListener(this));b.on("change",function(i){var h=b.value*1;b.value=h<10?"0"+h:h;this.onChange()}.bindAsEventListener(this));b.on("focus",function(h){b.select()}.bindAsEventListener(this));var a=new Element("div",{"class":"_pp_highlight _pp_timepicker_up"});this.setBehavior(a,b,this.increment,e,c);var f=new Element("div",{"class":"_pp_highlight _pp_timepicker_down"});this.setBehavior(f,b,this.decrement,e,c);g.appendChild(a);g.appendChild(b);g.appendChild(f);return g},setBehavior:function(c,b,g,h,f){var e=false;var a=(h-f>30)?5:1;c.on("mousedown",function(j){e=true;var i;setTimeout(function(){if(e){i=setInterval(function(){if(e){g(b,h,f,a);this.onChange()}else{clearInterval(i)}}.bind(this),200)}}.bind(this),500);g(b,h,f);this.onChange()}.bindAsEventListener(this));c.on("mouseup",function(i){e=false}.bindAsEventListener(this));c.on("mouseout",function(i){e=false}.bindAsEventListener(this))},increment:function(b,f,c,a){if(!a){a=1}var e=b.value*1;e+=a;e=e-e%a;if(e>f){e=c}b.value=e<10?"0"+e:e},decrement:function(b,f,c,a){if(!a){a=1}var e=b.value*1;e-=a;e=e-e%a;if(e<c){e=f}b.value=e<10?"0"+e:e},onChange:function(){if(this.options.onChange){this.options.onChange(this.getTime())}},onSelect:function(){if(this.options.onSelect){this.options.onSelect(this.getTime())}},getTime:function(){var b=new Date();var a=this.hours.value*1;if(!this.options.use24hrs){if(a==12&&this.ampm=="AM"){a=0}else{if(a<12&&this.ampm=="PM"){a+=12}}}b.setHours(a);b.setMinutes(this.minutes.value*1);b.setSeconds(this.seconds.value*1);return b},setTime:function(e){var c=e.getHours();var a=e.getMinutes();var b=e.getSeconds();if(!this.options.use24hrs){this.ampm="AM";this.am.addClassName("_pp_highlight");this.pm.removeClassName("_pp_highlight");if(c>12){c-=12;this.ampm="PM";this.pm.addClassName("_pp_highlight");this.am.removeClassName("_pp_highlight")}else{if(c==0){c=12}}}this.hours.value=c>=10?c:"0"+c;this.minutes.value=a>=10?a:"0"+a;this.seconds.value=b>=10?b:"0"+b}});Protoplasm.register("timepicker",Control.TimePicker);if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize treelist")}if(window.Control==undefined){Control={}}Protoplasm.loadStylesheet("treelist.css","treelist");Control.TreeList=Class.create({initialize:function(b,a){b=$(b);if(c=b.retrieve("treelist")){c.destroy()}a=Object.extend({selectable:true},a||{});var d=Protoplasm.base("treelist");if(!a.collapsedIcon){a.collapsedIcon=d+"collapsed.png"}if(!a.collapsedHoverIcon){a.collapsedHoverIcon=d+"collapsed-hover.png"}if(!a.expandedIcon){a.expandedIcon=d+"expanded.png"}if(!a.expandedHoverIcon){a.expandedHoverIcon=d+"expanded-hover.png"}this.element=b;this.options=a;this.listeners=[b.on("selectstart",function(f){Event.stop(f)}.bindAsEventListener(this)),b.on("mousedown",function(f){Event.stop(f)}.bindAsEventListener(this)),Event.on(window,"unload",this.destroy.bindAsEventListener(this))];this.selected=null;b.addClassName("_pp_treelist");this.extended=[Protoplasm.extend(b,{destroy:this.destroy.bind(this)})];b.select("li").each(this.initListItem.bind(this));b.store("treelist",this)},destroy:function(){this.extended.each(Protoplasm.revert);this.listeners.invoke("stop");var a=this.element;a.select("._pp_treelist_icon").invoke("remove");a.select("ul").invoke("show");a.select("._pp_treelist_selectable").each(function(b){while(b.firstChild){b.parentNode.insertBefore(b.firstChild,b.parentNode.firstChild)}b.remove()});a.select("._pp_highlight").invoke("removeClassName","_pp_highlight");a.removeClassName("_pp_treelist");a.store("treelist",null)},initListItem:function(b){var e=b.next();var h=new Element("span",{"class":"_pp_treelist_selectable"});while(b.firstChild){h.appendChild(b.firstChild)}b.appendChild(h);if(e&&e.tagName=="UL"){e.hide();var f=new Element("div",{"class":"_pp_treelist_icon"});b.insert({top:f});var d=this.open(b,f,e);var g=this.close(b,f,e);var a=this.toggle(f,d,g);this.listeners.push(f.on("click",a));this.listeners.push(b.on("dblclick",a));this.extended.push(Protoplasm.extend(b,{open:d,close:g,toggle:a}))}if(this.options.onOpen){this.listeners.push(b.on("dblclick",d))}if(this.options.selectable){this.listeners.push(b.on("click",function(i){if(this.selected){this.selected.removeClassName("_pp_highlight")}h.addClassName("_pp_highlight");this.selected=h;this.select(b)}.bindAsEventListener(this)))}},close:function(a,d,b){return function(f){if(d.hasClassName("_pp_treelist_icon_expanded")){d.removeClassName("_pp_treelist_icon_expanded");b.select("ul").invoke("hide");b.select("._pp_treelist_icon_expanded").invoke("removeClassName","_pp_treelist_icon_expanded");b.hide()}if(f){Event.stop(f)}}.bindAsEventListener(this)},open:function(a,d,b){return function(f){if(!d.hasClassName("_pp_treelist_icon_expanded")){d.addClassName("_pp_treelist_icon_expanded");if(b.childElements().length==0){this.loadChildItems(b)}b.show()}if(this.options.onOpen){this.options.onOpen(a.id?a.id:a.textContent,a)}if(f){Event.stop(f)}}.bindAsEventListener(this)},toggle:function(b,a,d){return function(f){if(b.hasClassName("_pp_treelist_icon_expanded")){d()}else{a()}}.bindAsEventListener(this)},loadChildItems:function(b){if(b.id&&this.options.childLoader){var d=this.listUpdater(b);b.update(new Element("li",{"class":"_pp_treelist_loading"}).update("Loading..."));var a=this.options.childLoader(b.id,d);if(a){d(a)}}},listUpdater:function(a){return function(b){a.update();b.each(a.insert.bind(a));a.select("li").each(this.initListItem.bind(this))}.bind(this)},select:function(a){if(this.options.onSelect){this.options.onSelect(a.id?a.id:a.textContent||a.innerText,a)}}});Protoplasm.register("treelist",Control.TreeList);if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize treeselect")}if(window.Control==undefined){Control={}}Control.TreeSelect=function(b,d){var w=null;function s(y){y=y.replace(/^\s+/,"");for(var x=y.length-1;x>=0;x--){if(/\S/.test(y.charAt(x))){y=y.substring(0,x+1);break}}return y}function n(C,x){var z=[];var B=(x||document).getElementsByTagName("*");var A=new RegExp("\\b"+C+"\\b");for(var y=0;y<B.length;++y){if(B[y].className.match(A)){z[z.length]=B[y]}}return z}function l(y,z){cl=y.className?y.className.split(/ /):[];for(var x=0;x<cl.length;++x){if(cl[x]==z){return}}cl[cl.length]=z;y.className=cl.join(" ")}function m(y,A){if(!y.className){return}cl=y.className.split(/ /);var z=[];for(var x=0;x<cl.length;++x){if(cl[x]!=A){z[z.length]=cl[x]}}y.className=z.join(" ")}function u(x){var i=window.event||x;if(i.stopPropagation){i.stopPropagation()}else{i.cancelBubble=true}}function o(y,i,x){if(y.addEventListener){y.addEventListener(i,x,false)}else{y.attachEvent("on"+i,x)}}function r(y,i,x){if(y.removeEventListener){y.removeEventListener(i,x,false)}else{y.detachEvent("on"+i,x)}}function g(i){return function(x){if(w){clearTimeout(w);w=null}k.value=i.id;if(j.nodeName.toUpperCase()=="INPUT"){j.value=s(i.childNodes[0].nodeValue)}else{j.innerHTML=s(i.childNodes[0].nodeValue)}u(x);q(x);return false}}function a(i){return function(x){if(w){clearTimeout(w);w=null}w=setTimeout(function(){var y=[];if(i.getElementsByTagName("ul").length){y[0]=i.getElementsByTagName("ul")[0]}var E=i.parentNode;while(E&&E!=b){if(E.nodeName.toUpperCase()=="UL"){y[y.length]=E}E=E.parentNode}var B=[];var C=b.getElementsByTagName("ul");for(var A=0;A<C.length;++A){var D=false;for(var z=0;z<y.length;++z){if(y[z]==C[A]){D=true;break}}if(!D){B[B.length]=C[A]}}for(var A=0;A<y.length;++A){y[A].style.display="block";y[A].style.zIndex=99;l(y[A].parentNode,"active")}for(var A=0;A<B.length;++A){B[A].style.display="none";B[A].style.zIndex=0;m(B[A].parentNode,"active")}w=null},200);u(x);return false}}function v(i){if(!i.id&&i.getElementsByTagName("ul").length){o(i,"click",a(i))}else{o(i,"click",g(i))}o(i,"mouseover",a(i));var x=i.getElementsByTagName("ul");if(x.length){l(i,"submenu")}}var k=n("itemvalue",b)[0];var j=n("itemname",b)[0];var c=b.getElementsByTagName("ul")[0];function e(i){if(c.style.display=="block"){c.style.display="none"}else{return h(i)}}function h(i){c.style.display="block";o(document,"click",q);u(i);return false}function q(z){var y=c.getElementsByTagName("ul");for(var x=0;x<y.length;++x){y[x].style.display="none";y[x].style.zIndex=0;m(y[x].parentNode,"active")}c.style.display="none";r(document,"click",q)}var t=document.createElement("img");t.src="/images/dropdown.png";t.style.verticalAlign="middle";if(j.nextSibling){j.parentNode.insertBefore(t,j.nextSibling)}else{j.parentNode.appendChild(t)}o(t,"click",e);o(j,"click",h);j.readOnly=true;var f=b.getElementsByTagName("li");for(var p=0;p<f.length;++p){v(f[p])}return{element:b}};Protoplasm.register("treeselect",Control.TreeSelect);if(typeof Protoplasm=="undefined"){throw ("protoplasm.js not loaded, could not intitialize upload")}if(typeof Control=="undefined"){Control={}}Protoplasm.loadStylesheet("upload.css","upload");Control.FileUpload=Class.create(function(){var a=/[\/\\]/g;return{initialize:function(d,b){d=$(d);if(!d||d.nodeName!="INPUT"||d.type!="file"||!d.form){throw ("element is not a file input.")}if(c=d.retrieve("fileupload")){c.destroy()}b=Object.extend({multiple:false,batch:false,inline:false,progress:true,progressUrl:null,onSuccess:Prototype.emptyFunction,onFailure:Prototype.emptyFunction,onComplete:Prototype.emptyFunction},b||{});wrapper=d.wrap("div");button=d.wrap("div",{"class":"_pp_upload_input _pp_button"}).insert("Select File(s)...");d.setOpacity(0);changeListener=d.on("change",this.fileAdded.bindAsEventListener(this));listeners=[changeListener,Event.on(window,"unload",this.destroy.bind(this))];if(b.inline){listeners.push(d.form.on("submit",this.submit.bindAsEventListener(this)))}d.store("fileupload",this);this.element=d;this.options=b;this.wrapper=wrapper;this.button=button;this.files=wrapper.appendChild(new Element("ul",{"class":"_pp_upload_files"}));this.handler=this.createHandler();this.uploads=[];this.changeListener=changeListener;this.listeners=listeners},createHandler:function(){if(typeof File!="undefined"&&typeof Ajax.getTransport().upload!="undefined"&&this.options.progress){return new Control.FileUpload.AjaxHandler(this)}else{return new Control.FileUpload.IFrameHandler(this)}},fileAdded:function(d){var b=this.element;var f=$H(this.handler.add(b));f.each(function(l){var g=l.key;var e=l.value;if(!this.options.multiple){for(var h=0;h<this.uploads.length;h++){this.cancel(h);this.uploads[h]&&this.uploads[h].remove()}}var p=new Element("li");p.appendChild(new Element("div",{"class":"_pp_upload_progress"}));p.appendChild(new Element("div",{"class":"_pp_upload_label"})).update(e);p.appendChild(b);this.files.appendChild(p);if(this.options.multiple){this.changeListener.stop();var j=new Element("div",{"class":"_pp_upload_change"});var n=j.appendChild(new Element("img",{src:Protoplasm.base("upload")+"remove.png"}));n.on("click",function(i){if(!(g in this.uploads&&this.handler.cancel(g))){p.remove()}Event.stop(i)}.bindAsEventListener(this));p.insert({top:j});var o=b.clone();o.store("fileupload",this);var k=o.on("change",this.fileAdded.bindAsEventListener(this));this.listeners.push(k);this.changeListeners=k;this.button.insert({top:o});b.hide();this.element=o}else{var m=new Element("div",{"class":"_pp_upload_change"});var n=m.appendChild(new Element("img",{src:Protoplasm.base("upload")+"change.png"}));p.insert({top:m});this.button.hide()}this.uploads[g]=p;if(!this.options.batch&&this.options.inline){this.upload(g)}}.bind(this))},destroy:function(){for(var b=0;b<this.listeners.length;++b){this.listeners[b].stop()}this.wrapper.replace(this.element);this.element.show();this.element.store("fileupload",null)},submit:function(d){if(d){Event.stop(d)}for(var b=0;b<this.uploads.length;++b){this.upload(b)}},upload:function(d){if(d in this.uploads){var b=this.uploads[d];b.down("div._pp_upload_label").addClassName("_pp_upload_loading");this.handler.upload(d)}},cancel:function(){for(var b=0;b<this.uploads.length;++b){this.handler.cancel(b)}},onProgress:function(g,b,e){if(g in this.uploads){var f=this.uploads[g];var d=f.getLayout().get("width")*(b/e);f.down("div._pp_upload_progress").style.width=d+"px"}},onSuccess:function(e,b,d){this.options.onSuccess(b);this.uploadComplete(e,b,d,true)},onFailure:function(e,b,d){this.options.onFailure(b);this.uploadComplete(e,b,d,false)},uploadComplete:function(h,b,e,g){if(h in this.uploads){var f=this.uploads[h];var d=f.down("div._pp_upload_label");d.removeClassName("_pp_upload_loading");f.down("div._pp_upload_progress").remove();f.down("div._pp_upload_change").remove();if(g){f.addClassName("_pp_upload_success");d.addClassName("_pp_upload_complete")}else{f.addClassName("_pp_upload_error");d.addClassName("_pp_upload_failed")}delete this.uploads[h]}if(this.uploads.filter(Prototype.K).size()==0){this.options.onComplete(b)}e.remove()},basename:function(b){return b?b.split(a).pop():b},dirname:function(b){return b&&b.match(a)?b.split(a).slice(0,-1).join("/"):""}}}());Control.FileUpload.AjaxHandler=Class.create(function(){return{initialize:function(d){this.control=d;this.action=d.element.form.action;this.method=d.element.form.method;this.params=null;if(fields=d.options.includeFields){var a={};var b=d.element.form.elements;fields.each(function(e){a[e]=b[e].value});this.params=$H(a).toQueryString()}this.uploads={};this.active={}},add:function(a){accepted={};if(a.files){$A(a.files).each(function(b){var d=Control.FileUpload.activeCount++;this.uploads[d]=[a,b];accepted[d]=b.name}.bind(this))}else{throw ("Browser does not support XHR File API")}return accepted},upload:function(g){if(g in this.uploads){u=this.uploads[g];var b=u[0];var d=u[1];var a=d.name?d.name:this.control.basename(d.value);var f={"Content-Disposition":"attachment; filename="+a};if(this.params){f["X-Upload-Parameters"]=this.params}var e=new Ajax.UploadRequest(this.action,{method:this.method,contentType:"application/octet-stream",requestHeaders:f,postBody:d,onProgress:function(h,i){this.control.onProgress(g,h,i)}.bind(this),onSuccess:function(h){delete this.uploads[g];if(this.active[g]){delete this.active[g];this.control.onSuccess(g,a,b)}}.bind(this),onFailure:function(h){delete this.uploads[g];if(this.active[g]){delete this.active[g];this.control.onFailure(g,a,b)}}.bind(this)});this.active[g]=e}},cancel:function(g){if(g in this.uploads){if(g in this.active){var d=this.uploads[g];var b=d[0];var e=d[1];var a=e.name?e.name:this.control.basename(e.value);var f=this.active[g].transport;delete this.active[g];f.abort();this.control.onFailure(g,a,b);return true}delete this.uploads[g]}return false}}}());Control.FileUpload.IFrameHandler=Class.create(function(){return{initialize:function(d){this.control=d;this.progressUrl=d.options.progressUrl;var a={};if(fields=d.options.includeFields){var b=d.element.form.elements;fields.each(function(e){a[e]=b[e].value})}this.params=$H(a);this.uploads={}},add:function(a){var b=Control.FileUpload.activeCount++;this.uploads[b]=a;accepted={};if(a.multiple&&a.files){accepted[b]=$A(a.files).pluck("name").join("<br />\n")}else{accepted[b]=this.control.basename(a.value)}return accepted},upload:function(e){if(e in this.uploads){file=this.uploads[e];file.store("parent",file.parentNode);var b=file.parentNode.appendChild(new Element("iframe",{name:"upload_iframe_"+e,"class":"_pp_upload_iframe"}));b.store("load",b.on("load",this.completeListener(e,file,this.control.onSuccess.bind(this.control))));b.store("error",b.on("error",this.completeListener(e,file,this.control.onFailure.bind(this.control))));var d=new Element("form",{action:file.form.action,method:file.form.method,enctype:"multipart/form-data",target:b.name});d.store("iframe",b);d.appendChild(file);if(this.params.size()){this.params.each(function(g){d.appendChild(new Element("input",{type:"hidden",name:g.key,value:g.value}))})}d.hide();document.body.appendChild(d);d.submit();if(this.progressUrl){var a=this.progressHandler(e,file);this.progressChecker=setTimeout(function(){a(a)},1000)}return[e]}},completeListener:function(d,a,b){return function(f){a.form.remove();a.retrieve("parent").appendChild(a);if(b){if(a.multiple&&a.files){$A(a.files).each(function(e){b(d,e.name,a)})}else{b(d,this.control.basename(a.value),a)}}if(this.progressChecker){clearTimeout(this.progressChecker);this.progressChecker=null}}.bind(this)},cancel:function(d){if(d in this.uploads){var a=this.uploads[d];var b=a.form.retrieve("iframe");delete this.uploads[d];if(b){b.retrieve("load").stop();b.retrieve("error").stop();b.src="javascript:false;";this.completeListener(d,a,this.control.onFailure.bind(this.control))();return true}}return false},checkProgressLater:function(a){if(this.progressChecker){this.progressChecker=setTimeout(function(){a(a)},1000)}},progressHandler:function(d,a){if(this.progressUrl){var b=this.progressUrl.toQueryParams();if(a.multiple&&a.files){b.files=a.files.pluck("name").map(escape).join(",")}else{b.files=escape(this.control.basename(a.value))}return function(e){new Ajax.Request(this.progressUrl,{parameters:b,onSuccess:function(f){console.log(f.responseText);this.checkProgressLater(e)}.bind(this),onFailure:function(f){this.checkProgressLater(e)}.bind(this)})}.bind(this)}return Prototype.emptyFunction}}}());Control.FileUpload.activeCount=0;Ajax.UploadRequest=Class.create(Ajax.Request,{initialize:function($super,b,a){Ajax.Base.prototype.initialize.bind(this)(a);this.transport=Ajax.getTransport();if(a.onProgress){if(this.transport.upload){this.transport.upload.addEventListener("progress",function(f){a.onProgress(f.loaded,f.total)}.bindAsEventListener(this),false)}else{try{this.transport.onprogress=function(f){a.onProgress(f.position,f.totalSize)}.bindAsEventListener(this)}catch(d){}}}this.request(b)}});Protoplasm.register("upload",Control.FileUpload);